<!DOCTYPE html>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<html lang="zh-cn">
  <head>
    <title>brettkk</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="http://jyywiki.cn/os/2022/
 02 ç¨‹åºä¸ç¼–è¯‘å™¨ ğŸ”—åœ¨vié‡Œç¼–è¯‘cæ–‡ä»¶ã€‚ :!gcc %
ä»€ä¹ˆæ˜¯ç¨‹åºï¼Ÿ ğŸ”—ä½ åœ¨å—äº¬å¤§å­¦ä¸Šè¿‡æœ€ç‰›çš„è¯¾æ˜¯ä»€ä¹ˆï¼Ÿ
ã€Šç¨‹åºè®¾è®¡è¯­è¨€çš„å½¢å¼è¯­ä¹‰ã€‹ æ¢çº¢ç‘¾
gdb a.out layout src (cç¨‹åºè§†è§’) layout asm ï¼ˆæ±‡ç¼–è§†è§’ï¼‰ start
é—®é¢˜1: gdb Unable to find Mach task port è§£å†³è¿‡ç¨‹ï¼š macä¸‹ä¸èƒ½å®‰è£…gdbï¼Œ lldbæ›¿ä»£ã€‚">
<meta name="generator" content="Hugo 0.84.0" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/zenburn.min.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<link rel="stylesheet" href="http://brettkk.github.io/css/syntax.css" />


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />




  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>




  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">â†</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title"></h1>

    <div class="tip">
        <time datetime="0001-01-01 00:00:00 &#43;0000 UTC">Jan 1, 0001</time>
        <span class="split">
          Â·
        </span>
        <span>
          1088 words
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          6 minute read
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#02-ç¨‹åºä¸ç¼–è¯‘å™¨">02 ç¨‹åºä¸ç¼–è¯‘å™¨</a>
      <ul>
        <li><a href="#ä»€ä¹ˆæ˜¯ç¨‹åº">ä»€ä¹ˆæ˜¯ç¨‹åºï¼Ÿ</a></li>
        <li><a href="#ä»€ä¹ˆæ˜¯æ­£ç¡®çš„ç¼–è¯‘">ä»€ä¹ˆæ˜¯æ­£ç¡®çš„ç¼–è¯‘ï¼Ÿ</a></li>
        <li><a href="#æ“ä½œç³»ç»Ÿçš„å¸¸è§åº”ç”¨ç¨‹åº">æ“ä½œç³»ç»Ÿçš„å¸¸è§åº”ç”¨ç¨‹åº</a></li>
      </ul>
    </li>
    <li><a href="#03-å¤šå¤„ç†å™¨ç¼–ç¨‹">03 å¤šå¤„ç†å™¨ç¼–ç¨‹</a>
      <ul>
        <li><a href="#å®ç°åŸå­æ€§">å®ç°åŸå­æ€§</a></li>
        <li><a href="#ç†è§£å¹¶å‘ç¨‹åºçš„æ‰§è¡Œ">ç†è§£å¹¶å‘ç¨‹åºçš„æ‰§è¡Œ</a></li>
        <li><a href="#å¹¶å‘æ§åˆ¶äº’æ–¥">å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥</a></li>
        <li><a href="#å¹¶å‘æ§åˆ¶-çº¿ç¨‹åŒæ­¥">å¹¶å‘æ§åˆ¶ï¼š çº¿ç¨‹åŒæ­¥</a></li>
      </ul>
    </li>
    <li><a href="#è™šæ‹ŸåŒ–">è™šæ‹ŸåŒ–</a>
      <ul>
        <li><a href="#è¿›ç¨‹">è¿›ç¨‹</a></li>
        <li><a href="#cæ ‡å‡†åº“çš„å®ç°">Cæ ‡å‡†åº“çš„å®ç°</a></li>
        <li><a href="#å®‰è£…qemu">å®‰è£…QEMU</a></li>
      </ul>
    </li>
    <li><a href="#æŒä¹…åŒ–">æŒä¹…åŒ–</a>
      <ul>
        <li><a href="#æ–‡ä»¶">æ–‡ä»¶</a></li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <p><a href="http://jyywiki.cn/os/2022/">http://jyywiki.cn/os/2022/</a></p>
<hr>
<h2 id="02-ç¨‹åºä¸ç¼–è¯‘å™¨">02 ç¨‹åºä¸ç¼–è¯‘å™¨ <a href="#02-%e7%a8%8b%e5%ba%8f%e4%b8%8e%e7%bc%96%e8%af%91%e5%99%a8" class="anchor">ğŸ”—</a></h2><p>åœ¨vié‡Œç¼–è¯‘cæ–‡ä»¶ã€‚ :!gcc %</p>
<h3 id="ä»€ä¹ˆæ˜¯ç¨‹åº">ä»€ä¹ˆæ˜¯ç¨‹åºï¼Ÿ <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e7%a8%8b%e5%ba%8f" class="anchor">ğŸ”—</a></h3><p>ä½ åœ¨å—äº¬å¤§å­¦ä¸Šè¿‡æœ€ç‰›çš„è¯¾æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ã€Šç¨‹åºè®¾è®¡è¯­è¨€çš„å½¢å¼è¯­ä¹‰ã€‹ æ¢çº¢ç‘¾</p>
<p>gdb a.out
layout src (cç¨‹åºè§†è§’)
layout asm ï¼ˆæ±‡ç¼–è§†è§’ï¼‰
start</p>
<p>é—®é¢˜1: gdb Unable to find Mach task port
è§£å†³è¿‡ç¨‹ï¼š macä¸‹ä¸èƒ½å®‰è£…gdbï¼Œ lldbæ›¿ä»£ã€‚</p>
<ul>
<li>ç¨‹åºæ˜¯çŠ¶æ€æœºã€‚
<ul>
<li>çŠ¶æ€ç­‰äºå†…å­˜+å¯„å­˜å™¨ã€‚è½¬ç§»å‡½æ•°çš„ç­‰äºç¨‹åºçš„ä¸€æ¡æ¡æŒ‡ä»¤ã€‚</li>
<li>gdbå•æ­¥è°ƒè¯•éé€’å½’çš„æ±‰è¯ºå¡”ã€‚</li>
<li>æ˜¯çŠ¶æ€æœºçš„è¯ä¸€å®šå¯ä»¥æœ‰å·¥å…·ï¼ˆgdbï¼Œlldbï¼‰è§‚å¯ŸçŠ¶æ€å’Œè½¬ç§»ä¹‹åçš„çŠ¶æ€ã€‚</li>
</ul>
</li>
</ul>
<p>çŠ¶æ€æœºï¼ˆç¨‹åºï¼‰å¦‚ä½•åœä¸‹æ¥ï¼Ÿ</p>
<p>è°ƒç”¨syscallæ—¶ï¼Œä»»ç”±osä¿®æ”¹ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_start</span>() {
<span style="color:#75715e">//å†™ä¸€ä¸ªæœ€å°ç‰ˆæœ¬çš„hello worldçš„Cç¨‹åºã€‚
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>);
}
</code></pre></div><p>gcc -c a.c &amp;&amp; objdump -d a.o &amp;&amp; ld a.o &amp;&amp; ./a.out</p>
<p>gdb a.out
starti
GDB å®˜æ–¹æ–‡æ¡£ã€‚ STFW, RTFMã€‚The friendly Manualã€‚</p>
<p>é—®é¢˜ï¼š hello worldçš„Cç¨‹åºæ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨å“ªé‡Œï¼Ÿ</p>
<p>ç­‰ä»·é—®ï¼š äºŒè¿›åˆ¶ç¨‹åºçŠ¶æ€æœºçš„åˆå§‹çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Ÿ mainçš„ç¬¬ä¸€æ¡æŒ‡ä»¤å—ï¼Ÿ libcçš„_startå‡½æ•°å—ï¼Ÿ</p>
<p>é—®gdbå§ã€‚ lib64/ld-linux-x86-64.so.2ä¸­ã€‚</p>
<p>lib64/ld-linux-x86-64.soåŠ è½½äº†libcã€‚</p>
<p>è°è§„å®šäº†æ˜¯ld-linux-x86-64.soï¼Œ è€Œä¸æ˜¯xxxx.so?
readelfã€‚ ä¸€åˆ‡å»ºç«‹åœ¨ç¡®å®šçš„æœºåˆ¶ä¸Šã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯æ­£ç¡®çš„ç¼–è¯‘">ä»€ä¹ˆæ˜¯æ­£ç¡®çš„ç¼–è¯‘ï¼Ÿ <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e6%ad%a3%e7%a1%ae%e7%9a%84%e7%bc%96%e8%af%91" class="anchor">ğŸ”—</a></h3><p>æ­£ç¡®æ€§ï¼š æºä»£ç çš„çŠ¶æ€æœº ä¸ äºŒè¿›åˆ¶çš„çŠ¶æ€æœºçš„å¯è§‚æµ‹è¡Œä¸ºä¸¥æ ¼ä¸€è‡´ã€‚</p>
<p>compiler ä¿è¯è§‚æµ‹ä¸€è‡´æ€§çš„å‰æä¸‹ æ”¹å†™ä»£ç ã€‚</p>
<h3 id="æ“ä½œç³»ç»Ÿçš„å¸¸è§åº”ç”¨ç¨‹åº">æ“ä½œç³»ç»Ÿçš„å¸¸è§åº”ç”¨ç¨‹åº <a href="#%e6%93%8d%e4%bd%9c%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%b8%b8%e8%a7%81%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f" class="anchor">ğŸ”—</a></h3><p>ä¸€èˆ¬çš„ç¨‹åº = è®¡ç®— -&gt; syscall -&gt; ...</p>
<p>åœ¨ä¸€èˆ¬çš„ç¨‹åºçš„è§†è§’ä¸‹æ“ä½œç³»ç»Ÿå°±æ˜¯syscallã€‚straceå‘½ä»¤ã€‚</p>
<p>core utilitiesã€‚</p>
<p>ç³»ç»Ÿå·¥å…·ã€‚ bashï¼Œ binutilsã€‚</p>
<p>é‡è¦å·¥å…·ï¼š gccï¼Œ binutils, gdb, straceã€‚</p>
<hr>
<h2 id="03-å¤šå¤„ç†å™¨ç¼–ç¨‹">03 å¤šå¤„ç†å™¨ç¼–ç¨‹ <a href="#03-%e5%a4%9a%e5%a4%84%e7%90%86%e5%99%a8%e7%bc%96%e7%a8%8b" class="anchor">ğŸ”—</a></h2><p>wget <a href="http://jyywiki.cn/pages/OS/2022/demos/thread.h">http://jyywiki.cn/pages/OS/2022/demos/thread.h</a></p>
<p>å¦‚ä½•è¯æ˜çº¿ç¨‹ç¡®å®å…±äº«å†…å­˜ï¼Ÿ</p>
<p>å¦‚ä½•è¯æ˜çº¿ç¨‹å…·æœ‰ç‹¬ç«‹çš„æ ˆï¼Œä»¥åŠæ ˆçš„èŒƒå›´ï¼Ÿ</p>
<p>8Mçš„çº¿ç¨‹æ ˆå¤§å°ã€‚</p>
<p>åˆ›å»ºçº¿ç¨‹ä½¿ç”¨äº†å“ªäº›ç³»ç»Ÿè°ƒç”¨ï¼Ÿ</p>
<p>èƒ½ä¸èƒ½åœ¨gdbä¸­è°ƒè¯•ï¼Ÿ</p>
<h3 id="å®ç°åŸå­æ€§">å®ç°åŸå­æ€§ <a href="#%e5%ae%9e%e7%8e%b0%e5%8e%9f%e5%ad%90%e6%80%a7" class="anchor">ğŸ”—</a></h3><p>äº’æ–¥å’ŒåŸå­æ€§ã€‚</p>
<p>lock(&amp;lk), unlock(&amp;lk) å¯ä»¥å®ç°ä¸´ç•ŒåŒºä¹‹é—´çš„çº¿ç¨‹ä¸²è¡ŒåŒ–æ‰§è¡Œã€‚</p>
<ul>
<li>99%çš„å¹¶å‘é—®é¢˜å¯ä»¥ç”¨ä¸€ä¸ªé˜Ÿåˆ—è§£å†³
<ul>
<li>worker threadå»é”ä¿æŠ¤çš„é˜Ÿåˆ—é‡Œå–ä»»åŠ¡</li>
<li>PDC chap 1 (<a href="https://web.mit.edu/dimitrib/www/pdc.html">https://web.mit.edu/dimitrib/www/pdc.html</a>)</li>
<li>own thinkingï¼Œæ¯”å¦‚æœ‰å“ªäº›å¼€æºé¡¹ç›®ï¼Ÿ</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> done;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">join</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>done) {
        ;
    }
}
</code></pre></div><p>// while (!done);
// å¯èƒ½è¢«ç¼–è¯‘å™¨ä¼˜åŒ–ä¸º
// if(!done) while(1);</p>
<p>gcc -c -o2 a.c | objdump -d a.o</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> done;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">join</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>done) {
        <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">:::</span><span style="color:#e6db74">&#34;memory&#34;</span>);
    }
}
</code></pre></div><p>åŠ ä¸Švolatileåï¼ŒæŸ¥çœ‹æ±‡ç¼–æŒ‡ä»¤ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šæŸ¥è¯¢å†…å­˜é‡Œçš„å˜é‡åã€‚
å› æ­¤äº§ç”Ÿäº†volatile(æ˜“å˜çš„)çš„ç¼–ç¨‹è¯­ä¹‰ï¼Œ æ‰€ä»¥æ¯æ¬¡è¯»æ˜“å˜çš„å˜é‡æ—¶è¯»å†…å­˜ï¼Œæ¯æ¬¡å†™æ˜“å˜çš„å˜é‡æ—¶å†™å†…å­˜ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">volatile</span> done;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">join</span>() {
    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>done) {
        ;
    }
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">T1</span>() {
    x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;memory&#34;</span>);
    printf(<span style="color:#e6db74">&#34;y = %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, y); 
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">T2</span>() {
    y <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;memory&#34;</span>);
    printf(<span style="color:#e6db74">&#34;x = %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, x);
}
<span style="color:#75715e">// pipe to head -n 1000000 |sort|uniq -c
</span><span style="color:#75715e">// å¯ä»¥çœ‹åˆ° x = 0 y = 0 å‡ºç°äº†...
</span></code></pre></div><p>nextï¼Œ åŠ ä¸Švolatileåä¿è¯æ±‡ç¼–å±‚é¢ä¸Šçš„è¯­ä¹‰æ­£ç¡®ã€‚ ä½†æ˜¯åœ¨cpuå†…éƒ¨ç»´æŠ¤æŒ‡ä»¤ä¾èµ–çš„DAGï¼Œä¸ä¾èµ–çš„æŒ‡ä»¤åŒæ—¶å‘å°„æ‰§è¡Œã€‚
ç°åœ¨çš„å¤„ç†å™¨ä¹Ÿæ˜¯æ•°æ®æµåˆ†æå™¨ï¼Œç¼–è¯‘å™¨ï¼Œåšå‡ºåº”æœ‰çš„åº”å¯¹ï¼Œå®ƒæ‰å¯ä»¥è·‘å¾—å¿«ã€‚
æ‰€ä»¥printf y å¯ä»¥åœ¨å†™å…¥x ä¹‹å‰æ‰§è¡Œã€‚å¯ä»¥åœ¨mfenceä¿è¯æŒ‡ä»¤æ‰§è¡Œé¡ºåºä¸ä»£ç ç¼–å†™é¡ºåºä¸€è‡´ã€‚</p>
<p>[1]<a href="https://research.swtch.com/hwmm" target="_blank" rel="noopener">Hardware Memory Models by Russ Cox</a></p>
<h3 id="ç†è§£å¹¶å‘ç¨‹åºçš„æ‰§è¡Œ">ç†è§£å¹¶å‘ç¨‹åºçš„æ‰§è¡Œ <a href="#%e7%90%86%e8%a7%a3%e5%b9%b6%e5%8f%91%e7%a8%8b%e5%ba%8f%e7%9a%84%e6%89%a7%e8%a1%8c" class="anchor">ğŸ”—</a></h3><p>å¹¶å‘ç¨‹åº = å¤šä¸ªæ‰§è¡Œæµï¼Œ å…±äº«å†…å­˜çš„çŠ¶æ€æœºã€‚</p>
<p>petersonç®—æ³•ã€‚
Aä¸¾æ——å­ï¼Œå¾€å•æ‰€é—¨ä¸Šè´´â€œBâ€æ­£åœ¨ä½¿ç”¨çš„æ ‡ç­¾ã€‚
Bä¸¾æ——å­ï¼Œå¾€å•æ‰€é—¨ä¸Šè´´â€œAâ€æ­£åœ¨ä½¿ç”¨çš„æ ‡ç­¾ã€‚
å½“ å¯¹æ–¹çš„æ——å­ä¸¾èµ·æ¥äº†ï¼Œä¸”é—¨ä¸Šçš„åå­—ä¸æ˜¯è‡ªå·±ï¼Œåˆ™ç­‰å¾…ã€‚å…¶ä»–æƒ…å†µï¼Œå¯ä»¥è¿›ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">volatile</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, turn <span style="color:#f92672">=</span> A;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Ta</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
        turn <span style="color:#f92672">=</span> B;
        <span style="color:#66d9ef">while</span>( y <span style="color:#f92672">&amp;&amp;</span> turn <span style="color:#f92672">==</span> B) ;
        critical_section();
        x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Tb</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        y <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
        turn <span style="color:#f92672">=</span> A;
        <span style="color:#66d9ef">while</span>( x <span style="color:#f92672">&amp;&amp;</span> turn <span style="color:#f92672">=</span> A) ;
        critical_section();
        y <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }
}
</code></pre></div><p>ç”»çŠ¶æ€æœºï¼ˆpc1, pc2, x, y, turnï¼‰ã€‚ç”¨å·¥å…·ç”»ã€‚
model checkerã€‚çŠ¶æ€æœºå¯ä»¥æŠ½è±¡ä¸ºå›¾ã€‚å¯è¾¾æ€§ã€‚</p>
<h3 id="å¹¶å‘æ§åˆ¶äº’æ–¥">å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ <a href="#%e5%b9%b6%e5%8f%91%e6%8e%a7%e5%88%b6%e4%ba%92%e6%96%a5" class="anchor">ğŸ”—</a></h3><p>å®ç°äº’æ–¥çš„æ ¹æœ¬å›°éš¾æ˜¯ï¼š ä¸èƒ½åŒæ—¶è¯»/å†™å†…å­˜ã€‚</p>
<p>å¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°çº¿ç¨‹äº’æ–¥ï¼Ÿ</p>
<h4 id="è‡ªæ—‹é”spin-lock">è‡ªæ—‹é”(spin lock)ã€‚ <a href="#%e8%87%aa%e6%97%8b%e9%94%81spin-lock" class="anchor">ğŸ”—</a></h4><p>ç¡¬ä»¶åŠ æŒ‡ä»¤ã€‚</p>
<p>xchgæŒ‡ä»¤ï¼š å…ˆçœ‹ä¸€ä¸‹ï¼Œç„¶åä¸­é€”æ²¡äººæ”¹åŠ¨æ—¶æ”¹æ‰ã€‚å…¶ä»–çš„stdatomic.h</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">int</span> table <span style="color:#f92672">=</span> YES;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lock</span>() {
retry:
    <span style="color:#66d9ef">int</span> got <span style="color:#f92672">=</span> xchg(<span style="color:#f92672">&amp;</span>table, NOPE);
    <span style="color:#66d9ef">if</span> (got <span style="color:#f92672">==</span> NOPE) <span style="color:#66d9ef">goto</span> retry;
    assert(got <span style="color:#f92672">==</span> yes);
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlock</span>() {
    xchg(<span style="color:#f92672">&amp;</span>table, YES);
}

<span style="color:#66d9ef">int</span> locked <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">lock</span>() {
    <span style="color:#66d9ef">while</span>( xchg(<span style="color:#f92672">&amp;</span>locked, <span style="color:#ae81ff">1</span>));
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlock</span>() { xchg(<span style="color:#f92672">&amp;</span>locked, <span style="color:#ae81ff">0</span>); }

</code></pre></div><p>x86çš„lockæŒ‡ä»¤çš„å®ç°ã€‚ L1 cacheçš„MESIçŠ¶æ€åè°ƒã€‚</p>
<p>RISC-Vçš„å¦ä¸€ç§åŸå­æ“ä½œçš„è®¾è®¡ã€‚</p>
<p>æœ¬è´¨æ˜¯load  exec storeçš„åŸå­æ€§ã€‚</p>
<p>Load-Reserved/Store-Conditional (LR/SC)</p>
<p>ä½¿ç”¨åœºæ™¯ï¼š çŸ­ä¸´ç•ŒåŒºï¼Œå°‘ç«äº‰ä¸‹ï¼Œé˜²æ­¢çº¿ç¨‹è¢«åˆ‡æ¢ï¼ˆç¨‹åºè‡ªèº«åšä¸åˆ°ï¼ŒOSæ§åˆ¶æŒé”æ—¶OSç¦æ­¢ä¸­æ–­å’ŒæŠ¢å ï¼‰ã€‚
æ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„ä½¿ç”¨spin lockã€‚</p>
<p>ç¼ºé™·ï¼š ç©ºè½¬ã€‚ è·å¾—è‡ªæ—‹é”çš„çº¿ç¨‹è¢«osåˆ‡æ¢å‡ºå»äº†ï¼ˆOSä¹Ÿå¾ˆéš¾ä¿è¯ï¼Œè™šæ‹Ÿæœºä¸èƒ½å…³ä¸­æ–­ï¼‰ã€‚</p>
<h4 id="äº’æ–¥é”mutex-lock">äº’æ–¥é”ï¼ˆmutex lockï¼‰ã€‚ <a href="#%e4%ba%92%e6%96%a5%e9%94%81mutex-lock" class="anchor">ğŸ”—</a></h4><p>å¤©é»‘è¯·é—­çœ¼ï¼Œåœæ­¢æ“ä½œã€‚</p>
<p>é•¿ä¸´ç•ŒåŒºçš„äº’æ–¥ã€‚å†™æ–‡ä»¶ã€‚æŠŠé”çš„å®ç°æ”¾åˆ°æ“ä½œç³»ç»Ÿé‡Œã€‚é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—®lockedã€‚</p>
<ul>
<li>è‡ªæ—‹é”
<ul>
<li>fast pathã€‚ xchg æˆåŠŸï¼Œè¿›å…¥</li>
<li>slow pathã€‚ xchg å¤±è´¥å¤±è´¥ï¼Œè‡ªæ—‹ç­‰å¾…</li>
</ul>
</li>
<li>äº’æ–¥é”ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—®locked
<ul>
<li>slow pathã€‚æ›´å¿«ã€‚ä¸Šé”å¤±è´¥çš„çº¿ç¨‹ä¸å†å ç”¨cpu</li>
<li>fast pathã€‚ä¸Šé”æˆåŠŸä¹Ÿéœ€è¦syscallåˆ°å†…æ ¸æ€</li>
</ul>
</li>
</ul>
<h4 id="futexfast-userspace-mutexes">futexï¼ˆFast Userspace muTexesï¼‰ <a href="#futexfast-userspace-mutexes" class="anchor">ğŸ”—</a></h4><p>å€Ÿé‰´ è‡ªæ—‹é”å’Œäº’æ–¥é”çš„ä¼˜ç‚¹ã€‚
è®¾è®¡futexçš„äººç¬¬ä¸€æ¬¡ä¹Ÿæ²¡æœ‰å†™å¯¹ã€‚</p>
<ul>
<li>fast pathã€‚ ä¸€æ¡åŸå­æŒ‡ä»¤ï¼Œä¸Šé”æˆåŠŸåç«‹å³è¿”å›ã€‚</li>
<li>slow pathã€‚ ä¸Šé”å¤±è´¥ï¼Œæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ç¡çœ ã€‚</li>
</ul>
<h3 id="å¹¶å‘æ§åˆ¶-çº¿ç¨‹åŒæ­¥">å¹¶å‘æ§åˆ¶ï¼š çº¿ç¨‹åŒæ­¥ <a href="#%e5%b9%b6%e5%8f%91%e6%8e%a7%e5%88%b6-%e7%ba%bf%e7%a8%8b%e5%90%8c%e6%ad%a5" class="anchor">ğŸ”—</a></h3><p>äº’æ–¥æ˜¯ç«äº‰ã€‚ åŒæ­¥æ˜¯åä½œã€‚</p>
<p>åŒæ­¥é—®é¢˜ï¼š ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼› å“²å­¦å®¶åƒé¥­ã€‚
åŒæ­¥çš„å®ç°æ–¹æ³•ï¼š æ¡ä»¶å˜é‡, ä¿¡å·é‡ã€‚</p>
<p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Tproduce</span>() { <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) printf(<span style="color:#e6db74">&#34;(&#34;</span>);}
 <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Tconsumer</span>() { <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) printf(<span style="color:#e6db74">&#34;)&#34;</span>);}
</code></pre></div><p>åŒæ­¥ï¼š 1 ç­‰åˆ°æœ‰ç©ºä½æ—¶æ‰èƒ½æ‰“å°å·¦æ‹¬å·ã€‚2 ç­‰åˆ°èƒ½é…å¯¹æ—¶æ‰èƒ½æ‰“å°å³æ‹¬å·ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;thread.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;thread-sync.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> n, count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
mutex_t lk <span style="color:#f92672">=</span> MUTEX_INIT();

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Tproduce</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
    retry:
        mutex_lock(<span style="color:#f92672">&amp;</span>lk);
        <span style="color:#66d9ef">if</span> (count <span style="color:#f92672">==</span> n)  {
            mutex_unlock(<span style="color:#f92672">&amp;</span>lk);
            <span style="color:#66d9ef">goto</span> retry;
        }
        count<span style="color:#f92672">++</span>;
        printf(<span style="color:#e6db74">&#34;(&#34;</span>);
        mutex_unlock(<span style="color:#f92672">&amp;</span>lk);   
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Tconsumer</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
    retry:
        mutex_lock(<span style="color:#f92672">&amp;</span>lk);
        <span style="color:#66d9ef">if</span> (count <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
            mutex_unlock(<span style="color:#f92672">&amp;</span>lk);
            <span style="color:#66d9ef">goto</span> retry;
        }
        count<span style="color:#f92672">--</span>;
        printf(<span style="color:#e6db74">&#34;)&#34;</span>);
        mutex_unlock(<span style="color:#f92672">&amp;</span>lk);
    }
}
</code></pre></div><p>ä¸ç®¡ç¼“å†²åŒºç©ºè¿˜æ˜¯æ»¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæ‹¿æ¥åŠ é”ã€‚</p>
<p>æ¡ä»¶å˜é‡ï¼šä¸‡èƒ½åŒæ­¥çš„æ–¹æ³•ã€‚</p>
<ul>
<li>æ¡ä»¶å˜é‡APIï¼š
<ul>
<li>wait(cv, mutex) è°ƒç”¨æ—¶å¿…é¡»å·²ç»è·å¾—mutexï¼Œåˆ™é‡Šæ”¾mutexï¼Œè¿›å…¥ç¡çœ ;</li>
<li>signal(cv) å”¤é†’ç­‰å¾…cvçš„çº¿ç¨‹ã€‚</li>
<li>broadcast/notifyAll(cv) å”¤é†’Allã€‚</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Tproduce</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        mutex_lock(<span style="color:#f92672">&amp;</span>lk);
        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>count <span style="color:#f92672">!=</span>n ) {
            mutex_unlock_and_sleep(<span style="color:#f92672">&amp;</span>lk);
            <span style="color:#75715e">// mutex_lock(&amp;lk);
</span><span style="color:#75715e"></span>        }
        count<span style="color:#f92672">++</span>;
        printf(<span style="color:#e6db74">&#34;(&#34;</span>);
        wakeup();
        mutex_unlock(<span style="color:#f92672">&amp;</span>lk);
    }
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Tconsumer</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        mutex_lock(<span style="color:#f92672">&amp;</span>lk);
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span> count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
            mutex_unlock_and_sleep(<span style="color:#f92672">&amp;</span>lk);
        }
        count<span style="color:#f92672">--</span>;
        printf(<span style="color:#e6db74">&#34;)&#34;</span>);
        wakeup();
        mutex_unlock(<span style="color:#f92672">&amp;</span>lk);
    }
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">// has bug in it. model checker.
</span><span style="color:#75715e">// producer å”¤é†’ producerï¼Œ æˆ–è€…consumer å”¤é†’ consumeræ—¶ï¼Œä»£ç æœ‰é—®é¢˜äº†...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> n, count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
mutex_t lk <span style="color:#f92672">=</span> MUTEX_INIT();
cond_t cv <span style="color:#f92672">=</span> COND_INIT();
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Tproduce</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        mutex_lock(<span style="color:#f92672">&amp;</span>lk);
        <span style="color:#66d9ef">if</span> (count <span style="color:#f92672">==</span> n) { <span style="color:#75715e">// æ”¹while
</span><span style="color:#75715e"></span>            cond_wait(<span style="color:#f92672">&amp;</span>cv, <span style="color:#f92672">&amp;</span>lk);
        }
        printf(<span style="color:#e6db74">&#34;(&#34;</span>); count<span style="color:#f92672">++</span>;
        cond_signal(<span style="color:#f92672">&amp;</span>cv); <span style="color:#75715e">//æ”¹broadcast
</span><span style="color:#75715e"></span>        mutex_unlock(<span style="color:#f92672">&amp;</span>lk);
    }
}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Tconsumer</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        mutex_lock(<span style="color:#f92672">&amp;</span>lk);
        <span style="color:#66d9ef">if</span> (count <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { <span style="color:#75715e">// æ”¹while
</span><span style="color:#75715e"></span>            cond_wait(<span style="color:#f92672">&amp;</span>cv, <span style="color:#f92672">&amp;</span>lk); <span style="color:#75715e">//è¢«å”¤é†’æ—¶æŒæœ‰mutex lockã€‚
</span><span style="color:#75715e"></span>        }
        printf(<span style="color:#e6db74">&#34;)&#34;</span>); count<span style="color:#f92672">--</span>;
        cond_signal(<span style="color:#f92672">&amp;</span>cv);
        mutex_unlock(<span style="color:#f92672">&amp;</span>lk);
    }
}

</code></pre></div><p>éœ€è¦2ä¸ªæ¡ä»¶å˜é‡ï¼Œä¿è¯produceråªå”¤é†’consumerï¼Œ consumeråªå”¤é†’producerã€‚</p>
<p>æ¡ä»¶å˜é‡ï¼š å®ç°å¹¶è¡Œè®¡ç®—ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">struct</span> job {
    <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>run)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>args);
    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>args;
}

<span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
    <span style="color:#66d9ef">struct</span> job <span style="color:#f92672">*</span>job;
    mutex_lock(<span style="color:#f92672">&amp;</span>mutex);
    <span style="color:#66d9ef">while</span> ( <span style="color:#f92672">!</span>(job<span style="color:#f92672">=</span>get_job()) ){
        wait(<span style="color:#f92672">&amp;</span>cv, <span style="color:#f92672">&amp;</span>mutex);
    }
    mutex_unlock(<span style="color:#f92672">&amp;</span>mutex);
    job<span style="color:#f92672">-&gt;</span>run(job<span style="color:#f92672">-&gt;</span>arg);
}
</code></pre></div><p>DAGï¼Œæ‹“æ‰‘æ’åºï¼ŒæŒ‰å±‚å®¹æ˜“å¹¶è¡ŒåŒ–è®¡ç®—ã€‚</p>
<p>æ¡ä»¶å˜é‡ï¼š å®ç°çº¿ç¨‹é—´çš„äº¤æ›¿æ‰“å°ã€‚</p>
<p>ä¸‰ä¸ªçº¿ç¨‹ï¼Œæ€»æ˜¯æ‰“å°&lt;&gt;&lt;<em>,  &gt;&lt;&gt;</em>ã€‚ fish.c</p>
<p>ä¿¡å·é‡ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">producer</span>() {
    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
        P(<span style="color:#f92672">&amp;</span>empty); <span style="color:#75715e">//
</span><span style="color:#75715e"></span>        printf(<span style="color:#e6db74">&#34;(&#34;</span>);
        V(<span style="color:#f92672">&amp;</span>fill);  <span style="color:#75715e">// fill++
</span><span style="color:#75715e"></span>    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">consumer</span>() {
    P(<span style="color:#f92672">&amp;</span>fill);
    printf(<span style="color:#e6db74">&#34;)&#34;</span>);
    V(<span style="color:#f92672">&amp;</span>empty); <span style="color:#75715e">// empty--
</span><span style="color:#75715e"></span>}
</code></pre></div><p>å“²å­¦å®¶åƒé¥­é—®é¢˜ã€‚ï¼ˆ1960 Djstraï¼‰</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">mutex_lock(<span style="color:#f92672">&amp;</span>mutex);
<span style="color:#66d9ef">while</span> ( <span style="color:#f92672">!</span>(avail[lhs] <span style="color:#f92672">&amp;&amp;</span> avail[rhs]) ) {
    wait(<span style="color:#f92672">&amp;</span>cv, <span style="color:#f92672">&amp;</span>mutex);
}
avail[lhs] <span style="color:#f92672">=</span> avail[rhs] <span style="color:#f92672">=</span> false; <span style="color:#75715e">// åœ¨é”çš„ä¿æŠ¤ä¸‹æ‹¿èµ· å·¦å³çš„å‰å­ã€‚
</span><span style="color:#75715e"></span>mutex_unlock(<span style="color:#f92672">&amp;</span>mutex);
<span style="color:#75715e">// åƒé¥­
</span><span style="color:#75715e"></span>mutex_lock(<span style="color:#f92672">&amp;</span>mutex);
avail[lhs]<span style="color:#f92672">=</span>avail[rhs]<span style="color:#f92672">=</span>true; <span style="color:#75715e">// è¿˜å›å»
</span><span style="color:#75715e"></span>broadcast(<span style="color:#f92672">&amp;</span>cv);
mutex_unlock(<span style="color:#f92672">&amp;</span>mutex);
</code></pre></div><p>ä¹Ÿå¯ä»¥ä¸ç”¨ä¿¡å·é‡ï¼Œ è®©ä¸€ä¸ªäººé›†ä¸­ç®¡ç†ã€‚ åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¸è§ã€‚</p>
<p>å…±äº«å†…å­˜æ˜¯ä¸‡æ¶ä¹‹æºã€‚<br>
do not communicate by sharing memmory, instead share memory by communicatingã€‚ -- effective go <br>
æ—¢ç„¶ç”Ÿäº§è€…æ¶ˆè´¹è€…èƒ½è§£å†³å¤§éƒ¨åˆ†é—®é¢˜çš„æ—¶å€™ï¼Œæä¾›APIå°±è¡Œäº†ã€‚ä¾‹å¦‚golangçš„channelï¼Œ rustçš„channelã€‚</p>
<p>è½¯ä»¶æ˜¯éœ€æ±‚ï¼ˆè§„çº¦ï¼‰åœ¨è®¡ç®—æœºæ•°å­—ä¸–ç•Œé‡Œçš„æŠ•å½±ã€‚</p>
<p>åº”å¯¹bugçš„æ–¹æ³•ã€‚ é˜²å¾¡æ€§ç¼–ç¨‹ã€‚</p>
<p>ä¸¾ä¾‹ï¼šå¹³è¡¡äºŒå‰æ ‘çš„æ—‹è½¬ã€‚
æŠŠæ¯ä¸ªèŠ‚ç‚¹&lt;x, y, a, b, c&gt;çš„assert &lt;left, right, parent&gt;å†™å‡ºæ¥ï¼Œå†™å‡ºè§„çº¦ï¼Œå°±å®Œå…¨çŸ¥é“ä»£ç è¯¥æ€ä¹ˆå†™äº†ã€‚
åœ¨å†™ä»£ç æ—¶å†™å‡ºassertï¼Œä¸ä»…å†™å®Œäº†ä»£ç ï¼Œè€Œä¸”è§£é‡Šä»£ç ä¸ºä»€ä¹ˆæ˜¯å¯¹çš„ï¼Œä¼šåŠ åˆ†ã€‚</p>
<p>spinlock-xv6.c ä¸­å„ç§é˜²å¾¡æ€§ç¼–ç¨‹ã€‚</p>
<p>åŠ¨æ€ç¨‹åºåˆ†æ sanitizerã€‚</p>
<h2 id="è™šæ‹ŸåŒ–">è™šæ‹ŸåŒ– <a href="#%e8%99%9a%e6%8b%9f%e5%8c%96" class="anchor">ğŸ”—</a></h2><h3 id="è¿›ç¨‹">è¿›ç¨‹ <a href="#%e8%bf%9b%e7%a8%8b" class="anchor">ğŸ”—</a></h3><p>pstree</p>
<p>loaderæŠŠosåŠ è½½è¿›æ¥ï¼Œæ‰§è¡Œkernel _start()ä»£ç ï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªç¨‹åº/bin/init initè¿›ç¨‹, ä¸­æ–­/å¼‚å¸¸å¤„ç†ç¨‹åºã€‚<br>
åç»­å…¶ä»–è¿›ç¨‹éƒ½æ˜¯initè¿›ç¨‹çš„å­è¿›ç¨‹ã€‚</p>
<p>åˆ›å»ºè¿›ç¨‹çš„system call apiã€‚ fork, execve, exit çŠ¶æ€æœºçš„åˆ›å»ºå’Œé€€å‡ºã€‚</p>
<p>folk() å‰å­ã€‚çŠ¶æ€æœºçš„å¤åˆ¶ã€‚
execve é‡ç½®ä¸€ä¸ªè¿›ç¨‹çš„çŠ¶æ€æœºï¼Œå¦å¤–ä¸€ä¸ªç¨‹åºçš„åˆå§‹åŒ–çŠ¶æ€æœºã€‚</p>
<ul>
<li>ä¸‰å¤§ç±»ç³»ç»Ÿè°ƒç”¨
<ul>
<li>è¿›ç¨‹çš„syscallï¼Œforkï¼Œexecve,exitã€‚</li>
<li>å†…å­˜çš„syscallï¼Œ mmapè™šæ‹Ÿåœ°å€ç©ºé—´ç®¡ç†ã€‚</li>
<li>æ–‡ä»¶çš„syscall, openï¼Œ close, read, write, mkdir, link, unlink</li>
<li>å…¶ä»–ï¼Œç½‘ç»œç­‰ç­‰ã€‚</li>
</ul>
</li>
</ul>
<h4 id="è¿›ç¨‹çš„åœ°å€ç©ºé—´">è¿›ç¨‹çš„åœ°å€ç©ºé—´ <a href="#%e8%bf%9b%e7%a8%8b%e7%9a%84%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4" class="anchor">ğŸ”—</a></h4><pre><code>SIGSEGã€‚ address boundary errror.

strace pmap pid &amp; | vim -

osæä¾›æŸ¥çœ‹è¿›ç¨‹åœ°å€ç©ºé—´çš„æœºåˆ¶ã€‚man 5 proc
/proc/pid/maps     

VSDOã€‚ åªè¯»ç³»ç»Ÿè°ƒç”¨ä¸é™·å…¥å†…æ ¸æ€ã€‚timeçš„å®ç°ã€‚vvarï¼Œ vdsoã€‚
ç³»ç»Ÿè°ƒç”¨åªæ˜¯ä¸€ç»„apiæ¥å£çš„çº¦å®šï¼Œ ä¸ä¸€å®šä¸€å®šæ‰§è¡ŒintæŒ‡ä»¤ã€‚

mmapã€‚

åœ°å€ç©ºé—´çš„éš”ç¦»ã€‚
</code></pre>
<h4 id="ç³»ç»Ÿè°ƒç”¨shell">ç³»ç»Ÿè°ƒç”¨ï¼Œshell <a href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8shell" class="anchor">ğŸ”—</a></h4><p>sh-xv6.c é›¶ä¾èµ–çš„shellå®ç°ã€‚</p>
<p>strace -f -o /tmp/strace.log ./sh
tail -f /tmp/strace.log</p>
<p>job control.
jobs, fg, bg, &amp;.</p>
<p>ctrl + z æŠŠviæ”¾åˆ°åå°è¿è¡Œã€‚</p>
<p>ä¸ºä»€ä¹ˆctrl + c å¯ä»¥é€€å‡ºç¨‹å¼ã€‚
ä¸ºä»€ä¹ˆæœ‰äº›ç¨‹åºä¸ä¼šé€€å‡ºï¼Ÿ SIGINT, SIGQUITã€‚ ç»ˆç«¯å‘å‡ºä¿¡å·ç»™å‰å°è¿›ç¨‹ï¼Œç¨‹åºæ˜¯å¦æ³¨å†Œä¿¡æ¯å¤„ç†å‡½æ•°æ¥å†³å®šæ˜¯å¦é€€å‡ºã€‚</p>
<p>sessionï¼Œ process groupå’Œä¿¡å·ã€‚SIDï¼Œ PGIDã€‚ nohupã€‚
man setpgidã€‚</p>
<p>ä¸ºä»€ä¹ˆtmuxå¯ä»¥ç®¡ç†å¤šä¸ªçª—å£ï¼Ÿ
strace -f -o /tmp/strace.log tmux
ç»ˆç«¯ã€‚ osä¸­ä¸€ç±»ç‰¹æ®Šçš„è®¾å¤‡ã€‚ ttyï¼Œ stty...
ä¸åŒçš„çª—å£æ˜¯ä¸åŒçš„ç»ˆç«¯è®¾å¤‡ã€‚</p>
<h3 id="cæ ‡å‡†åº“çš„å®ç°">Cæ ‡å‡†åº“çš„å®ç° <a href="#c%e6%a0%87%e5%87%86%e5%ba%93%e7%9a%84%e5%ae%9e%e7%8e%b0" class="anchor">ğŸ”—</a></h3><p>Cè¯­è¨€æ˜¯ä»€ä¹ˆï¼Ÿ åŒ…å«ä»€ä¹ˆï¼Ÿ</p>
<p>libcã€‚</p>
<ul>
<li>stddef.h    size_t</li>
<li>stdint.h    int32_t, uint64</li>
<li>stdbool.h   bool, true, false</li>
<li>float.h, limits.h</li>
<li>stdarg.h    syscall, syscall0, syscall1</li>
<li>inttypes.h</li>
</ul>
<center><strong>å°è£…ç³»ç»Ÿè°ƒç”¨ã€‚</strong></center>
execlp -> execve
memset å¤šçº¿ç¨‹è®¿é—®ã€‚æ ‡å‡†åº“åªå¯¹â€œæ ‡å‡†åº“å†…éƒ¨æ•°æ®â€çš„çº¿ç¨‹å®‰å…¨æ€§è´Ÿè´£ã€‚
<center><strong>å°è£…çº¯ç²¹çš„è®¡ç®—ã€‚</strong></center>
<p>æ’åºå’ŒæŸ¥æ‰¾ã€‚ qsortï¼Œ bsearchã€‚</p>
<center><strong>å°è£…osé‡Œçš„å¯¹è±¡ã€‚ æ–‡ä»¶æè¿°ç¬¦ã€‚</strong></center>
<p>extern char **environ; åœ¨å“ªé‡Œå®šä¹‰ï¼Œè°èµ‹å€¼çš„ã€‚</p>
<center><strong>å°è£…åœ°å€ç©ºé—´</strong></center>
å†…å­˜ç©ºé—´çš„ç®¡ç†ã€‚malloc, freeã€‚åŒºé—´ç®¡ç†é—®é¢˜ã€‚
<ul>
<li>
<p>è¶Šå°çš„å¯¹è±¡åˆ†é…è¶Šé¢‘ç¹</p>
</li>
<li>
<p>è¾ƒä¸ºé¢‘ç¹åœ°åˆ†é…ä¸­ç­‰å¤§å°çš„å¯¹è±¡</p>
</li>
<li>
<p>ä½é¢‘ç‡çš„åˆ†é…å¤§å¯¹è±¡</p>
</li>
<li>
<p>è®¾è®¡ä¸¤å¥—ç³»ç»Ÿï¼ˆäººç±»ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œç›´è§‰åé¦ˆï¼Œç†æƒ³æ€è€ƒï¼‰</p>
<ul>
<li>fast path æ€§èƒ½å¥½ï¼Œè¦†ç›–å¤§éƒ¨åˆ†æƒ…å†µ
<ul>
<li>per cpu, per thread</li>
</ul>
</li>
<li>slow path
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<center><strong> æ— é™çš„å°è£… </strong></center>
<p>The GNU C Library
Newlib</p>
<ul>
<li>C++ ç¼–è¯‘å™¨</li>
<li>CPython</li>
<li>Go
<ul>
<li>æœ€å¼€å§‹çš„ç¼–è¯‘å™¨æ˜¯Cå†™çš„ã€‚</li>
</ul>
</li>
</ul>
<pre><code class="language-mermaid" data-lang="mermaid">graph TB
    Start(å¼€å§‹) --&gt; Open[æ‰“å¼€å†°ç®±é—¨]
    Open --&gt; Put[æŠŠå¤§è±¡æ”¾è¿›å»]
    Put[æŠŠå¤§è±¡æ”¾è¿›å»] --&gt; IsFit{&quot;å†°ç®±å°ä¸å°ï¼Ÿ&quot;}
    
    IsFit --&gt;|ä¸å°| Close[æŠŠå†°ç®±é—¨å…³ä¸Š]
    Close --&gt; End(ç»“æŸ)
        
    IsFit --&gt;|å°| Change[æ¢ä¸ªå¤§å†°ç®±]
    Change --&gt; Open
</code></pre><pre><code class="language-goat" data-lang="goat">      .               .                .               .--- 1          .-- 1     / 1
     / \              |                |           .---+            .-+         +
    /   \         .---+---.         .--+--.        |   '--- 2      |   '-- 2   / \ 2
   +     +        |       |        |       |    ---+            ---+          +
  / \   / \     .-+-.   .-+-.     .+.     .+.      |   .--- 3      |   .-- 3   \ / 3
 /   \ /   \    |   |   |   |    |   |   |   |     '---+            '-+         +
 1   2 3   4    1   2   3   4    1   2   3   4         '--- 4          '-- 4     \ 4

</code></pre><h3 id="å®‰è£…qemu">å®‰è£…QEMU <a href="#%e5%ae%89%e8%a3%85qemu" class="anchor">ğŸ”—</a></h3><pre><code>$./configure
Using './build' as the directory for build output

ERROR: Cannot find Ninja 
</code></pre><p>echo 'eval &quot;$(/opt/homebrew/bin/brew shellenv)&quot;' &gt;&gt; ~/.zprofile <br>
brew install ninja<br></p>
<p>[]<a href="https://macappstore.org/ninja/" target="_blank" rel="noopener"> Install ninja on Mac OSX</a></p>
<pre><code>Using './build' as the directory for build output
Disabling PIE due to missing toolchain support

ERROR: pkg-config binary 'pkg-config' not found
</code></pre><p>brew install pkg-config</p>
<h2 id="æŒä¹…åŒ–">æŒä¹…åŒ– <a href="#%e6%8c%81%e4%b9%85%e5%8c%96" class="anchor">ğŸ”—</a></h2><h3 id="æ–‡ä»¶">æ–‡ä»¶ <a href="#%e6%96%87%e4%bb%b6" class="anchor">ğŸ”—</a></h3>
    </div>

    
    
    

</section>


    </main>
    
    <footer id="footer">
    

    <script src="https://utteranc.es/client.js"
repo="brettKK/brettkk.github.io"
issue-term="title"
theme="github-light"
crossorigin="anonymous"
async>
</script>  

    <div class="copyright">
    
       Â© Copyright 
       2022 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-cactus-plus'>nodejh</a>
      </div>
    
</footer>




  </body>
</html>
