<!DOCTYPE html>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<html lang="zh-cn">
  <head>
    <title>goåŒæ­¥ç¼–ç æ–¹å¼ | brettkk</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="åç¨‹åˆ‡æ¢ä¸çº¿ç¨‹åˆ‡æ¢çš„åŒºåˆ« åˆ‡æ¢éœ€è¦åˆ‡æ¢2ä¸ªåœ°æ–¹ï¼šæ ˆå’Œå¯„å­˜å™¨ã€‚å">
<meta name="generator" content="Hugo 0.103.1" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/zenburn.min.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<link rel="stylesheet" href="http://brettkk.github.io/css/syntax.css" />


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />




  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>




  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">â†</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">goåŒæ­¥ç¼–ç æ–¹å¼</h1>

    <div class="tip">
        <time datetime="2021-05-06 18:34:48 &#43;0800 CST">May 6, 2021</time>
        <span class="split">
          Â·
        </span>
        <span>
          2089 words
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          5 minute read
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#syncwaitgroup">sync.WaitGroup</a>
          <ul>
            <li><a href="#waitgroupä½¿ç”¨">WaitGroupä½¿ç”¨</a></li>
          </ul>
        </li>
        <li><a href="#channel">channel</a>
          <ul>
            <li><a href="#channel-ä½¿ç”¨è¯´æ˜">channel ä½¿ç”¨è¯´æ˜</a></li>
            <li><a href="#channel-é”™è¯¯ç¤ºä¾‹">channel é”™è¯¯ç¤ºä¾‹</a></li>
            <li><a href="#é”™è¯¯æ“ä½œpanic">é”™è¯¯æ“ä½œPanic</a></li>
          </ul>
        </li>
        <li><a href="#context">context</a>
          <ul>
            <li><a href="#contextä½¿ç”¨è¯´æ˜">contextä½¿ç”¨è¯´æ˜</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <ul>
<li>åç¨‹åˆ‡æ¢ä¸çº¿ç¨‹åˆ‡æ¢çš„åŒºåˆ«
<ul>
<li>åˆ‡æ¢éœ€è¦åˆ‡æ¢2ä¸ªåœ°æ–¹ï¼šæ ˆå’Œå¯„å­˜å™¨ã€‚åç¨‹åˆ‡æ¢æ˜¯ç”¨æˆ·æ€çš„æ™®é€šå‡½æ•°è°ƒç”¨ã€‚calling conventionçº¦å®šäº†åªéœ€è¦ä¿å­˜å°‘é‡å¯„å­˜å™¨ï¼Œä½†çº¿ç¨‹åˆ‡æ¢éœ€è¦ä¿å­˜æ›´å¤šçš„å¯„å­˜å™¨åˆ°æ ˆä¸Šã€‚</li>
<li>çº¿ç¨‹åˆ‡æ¢éœ€è¦ç³»ç»Ÿè°ƒç”¨åˆ°ç³»ç»Ÿæ€è¿›è¡Œã€‚</li>
</ul>
</li>
</ul>
<p>golangæä¾›äº†æ¯”è¾ƒä¾¿æ·çš„åç¨‹å¹¶å‘ç¼–ç¨‹æ–¹å¼ã€‚golangçš„å¹¶å‘å•å…ƒæ˜¯goroutineã€‚ç›®å‰å®ç°å¤šä¸ªgoroutineåŒæ­¥çš„ä¸»è¦æ–¹å¼æœ‰ï¼š syncåŒ…ï¼Œ runtimeåŒ…ä¸‹çš„channelï¼ŒcontextåŒ…ã€‚</p>
<h2 id="syncwaitgroup">sync.WaitGroup <a href="#syncwaitgroup" class="anchor">ğŸ”—</a></h2><p>æ ‡å‡†åº“syncé‡Œçš„Waitgroupï¼Œç”¨æ¥é˜»å¡ä¸»åç¨‹å»ç­‰å¾…æ‰€æœ‰åç¨‹æ‰§è¡Œå®Œã€‚WaitGroupä¸»è¦ä¸‰ä¸ªæ–¹æ³•ï¼šAddæ–¹æ³•æ·»åŠ ç­‰å¾…çš„åç¨‹æ•°é‡ï¼ŒDoneæ–¹æ³•ç­‰äºAdd(-1)å‡å°‘ç­‰å¾…çš„åç¨‹æ•°é‡ï¼ŒWaitæ–¹æ³•é˜»å¡ä¸»åç¨‹ã€‚åŸç†ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><p class="markdown-image">
  <img src="/golang/golang_sync.png" alt="image"  />
</p></p>
<h3 id="waitgroupä½¿ç”¨">WaitGroupä½¿ç”¨ <a href="#waitgroup%e4%bd%bf%e7%94%a8" class="anchor">ğŸ”—</a></h3><p>WaitGroupåœ¨å·¥ä½œä¸­ç»å¸¸ä¼šä½¿ç”¨åˆ°ã€‚ä¾‹å¦‚ï¼šéœ€è¦å¹¶è¡Œå¤„ç†ä¸€äº›å­ä»»åŠ¡ï¼Œéœ€è¦èµ·å¤šä¸ªåç¨‹å¯¹ä¸€äº›å¤æ‚ç»“æ„ä½“çš„å„ä¸ªå­—æ®µè¿›è¡Œåˆå§‹åŒ–ç­‰ã€‚ç®€å•çš„ä½¿ç”¨è¯´æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">fun</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>() 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="channel">channel <a href="#channel" class="anchor">ğŸ”—</a></h2><p>é€šé“æ˜¯golangä¸­åç¨‹é€šä¿¡çš„ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥çµæ´»ã€é«˜æ•ˆæ”¯æŒåç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚é€šé“ä¸åç¨‹ä¹‹é—´çš„äº¤äº’æµç¨‹å›¾å› æ˜¯å¦å­˜åœ¨ç¼“å†²åŒºã€ç¼“å†²åŒºæ˜¯å¦å¡«æ»¡ã€æ˜¯å¦å­˜åœ¨å‘é€ç­‰å¾…é˜Ÿåˆ—ç­‰ï¼Œä¼šåœ¨è¿‡ç¨‹ä¸Šä¼šå­˜åœ¨ä¸åŒã€‚ä¸‹é¢ç»™å‡ºçš„ç¤ºæ„å›¾æ˜¯é’ˆå¯¹åˆ©ç”¨æ— ç¼“å†²é€šé“è¿›è¡Œé€šä¿¡çš„å…¶ä¸­ä¸€ç§æƒ…å†µï¼Œä¸»è¦æ˜¯ä¸ºäº†ç®€åŒ–æµç¨‹å’Œçªå‡ºä¸»è¦åŠŸèƒ½ç‚¹ã€‚å›¾ä¸­hchanæ˜¯é€šé“çš„åº•å±‚æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ä¸»è¦åŒ…å«ï¼š bufä¸ºæ•°æ®å­˜å‚¨åŒºï¼Œ recvqå’Œsendqä¸ºåœ¨æ­¤é€šé“ä¸Šç­‰å¾…æ¥å—å’Œå‘é€çš„åç¨‹é˜Ÿåˆ—ï¼Œlockä¸ºä¿æŠ¤é€šé“æ•°æ®çš„é”ç­‰ã€‚Pä¸ºè¿è¡Œæ—¶çš„åç¨‹è°ƒåº¦å™¨ã€‚åŸç†ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><p class="markdown-image">
  <img src="/golang/hchan.png" alt="image"  />
</p></p>
<h3 id="channel-ä½¿ç”¨è¯´æ˜">channel ä½¿ç”¨è¯´æ˜ <a href="#channel-%e4%bd%bf%e7%94%a8%e8%af%b4%e6%98%8e" class="anchor">ğŸ”—</a></h3><p>é€šè¿‡æ— ç¼“å†²çš„é€šé“ï¼Œé˜»å¡ä¸€ä¸ªåç¨‹ï¼Œç­‰å¾…å¦ä¸€ä¸ªåç¨‹å”¤é†’ã€‚ä¾‹å¦‚ï¼šmainåç¨‹åœ¨é€šé“çš„æ¥å—é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œ ç­‰workeråç¨‹å†™å…¥æ•°æ®åï¼Œmainåç¨‹æ‰ä¼šå”¤é†’å¹¶ç»§ç»­æ‰§è¡Œã€‚é€šä¿¡çš„æ•°æ®æ˜¯ç›´æ¥å†™ä¸€ä¸ªåç¨‹çš„stackã€‚è¿™æ ·å¯ä»¥çœå»å»æ“ä½œé€šé“çš„bufï¼Œå‡å°‘å†…å­˜æ‹·è´ã€‚ç®€å•çš„ä½¿ç”¨è¯´æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">done</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">done</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">done</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">worker</span>(<span style="color:#a6e22e">done</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">done</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>channelè¯»å†™è¶…æ—¶çš„å¤„ç†ã€‚Go è¯­è¨€çš„ channel æœ¬èº«æ˜¯ä¸æ”¯æŒ timeout çš„ï¼Œä¸€èˆ¬å®ç° channel çš„è¯»å†™è¶…æ—¶é‡‡ç”¨ select + timeçš„æ–¹å¼ã€‚å®ä¾‹è¯´æ˜å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//process   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ch</span><span style="color:#f92672">&lt;-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="channel-é”™è¯¯ç¤ºä¾‹">channel é”™è¯¯ç¤ºä¾‹ <a href="#channel-%e9%94%99%e8%af%af%e7%a4%ba%e4%be%8b" class="anchor">ğŸ”—</a></h3><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// æ­»é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ch</span> <span style="color:#75715e">//block
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// æ­»é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e">// block
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// æ­»é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ch</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>  <span style="color:#75715e">//nil channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span> { <span style="color:#75715e">// &lt;-ch  channel read
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>        }(<span style="color:#a6e22e">ch</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e">// channel write
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// goroutineæ³„æ¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// process more than 100ms
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// process done
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">After</span>(<span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span>) 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// process timeout
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="é”™è¯¯æ“ä½œpanic">é”™è¯¯æ“ä½œPanic <a href="#%e9%94%99%e8%af%af%e6%93%8d%e4%bd%9cpanic" class="anchor">ğŸ”—</a></h3><pre tabindex="0"><code>// send on close channel å¾€å·²å…³é—­çš„ channel å†™æ•°æ®ä¼š panic
// closing on close channel  å†™å…¥ç«¯æ— æ³•çŸ¥é“ channel æ˜¯å¦å·²ç»å…³é—­
// send or read on nil channel channelåˆå§‹åŒ–ä½¿ç”¨é”™è¯¯

1. ä¸è¦å°è¯•åœ¨è¯»å–ç«¯å…³é—­ channel 
2. ä¸€ä¸ªå†™å…¥ç«¯ï¼Œåœ¨è¿™ä¸ªå†™å…¥ç«¯å¯ä»¥æ”¾å¿ƒå…³é—­ channel
3. å¤šä¸ªå†™å…¥ç«¯æ—¶ï¼Œä¸è¦åœ¨å†™å…¥ç«¯å…³é—­ channel 
</code></pre><h2 id="context">context <a href="#context" class="anchor">ğŸ”—</a></h2><p>contextæ˜¯åœ¨contextåŒ…é‡Œå®šä¹‰çš„ä¸€ç§æ¥å£ã€‚åœ¨contextåŒ…ä¸­å¯ä»¥é€šè¿‡WithCancelã€WithDeadlineã€WithTimeoutã€WithValueè¿™å››ä¸ªæ–¹æ³•ç”Ÿæˆæ–° Contextã€‚WithValueæ–¹æ³•ç”Ÿæˆçš„contextå¯ä»¥åšåˆ°äº†è·¨APIçš„ä¼ å€¼åŠŸèƒ½ã€‚WithTimeoutæ–¹æ³•æ˜¯å¯¹WithDeadlineçš„å°è£…ã€‚WithDeadlineæ–¹æ³•ç”Ÿæˆçš„contextå®ç°äº†å®šæ—¶cancelçš„åŠŸèƒ½ã€‚</p>
<p>ä¸‹é¢ä»¥WithCancelä¸ºå…¥å£ï¼Œä»¥æºç ï¼ˆgo1.12.7ï¼‰ä¸ºå†…å®¹ä½œä»‹ç»ã€‚å½“ parent çš„ Done() å…³é—­çš„æ—¶å€™ï¼Œå­©å­ ctx çš„ Done() ä¹Ÿä¼šå…³é—­ï¼Œ è¿™ç§æƒ…å†µæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå…·ä½“è¿‡ç¨‹åˆ†ä¸¤ç§æƒ…å†µï¼š 1 å½“ä¼ å…¥çš„contextæ˜¯åº“é‡Œæ”¯æŒçš„cancelCtxã€timeCtxæ—¶ï¼ŒchildåŠ å…¥parentçš„è¡ç”Ÿmapä¸­ï¼› 2 å½“ä¼ å…¥çš„contextä¸ºè‡ªå®šä¹‰å®ç°ç±»æ—¶ï¼Œæ ‡å‡†åº“æ˜¯æ–°èµ·goroutineç›‘å¬ä¿¡å·å¹¶æ‰§è¡Œcancelå­contextçš„è¿‡ç¨‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// åœ¨ parent å’Œ child ä¹‹é—´åŒæ­¥å–æ¶ˆçš„ä¿¡å·ï¼Œä¿è¯åœ¨ parent è¢«å–æ¶ˆæ—¶ï¼Œchild ä¹Ÿä¼šæ”¶åˆ°å¯¹åº”çš„ä¿¡å·ï¼Œä¸ä¼šå‘ç”ŸçŠ¶æ€ä¸ä¸€è‡´çš„é—®é¢˜ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">propagateCancel</span>(<span style="color:#a6e22e">parent</span> <span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">child</span> <span style="color:#a6e22e">canceler</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">Done</span>() <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> { <span style="color:#75715e">//parentä¸ä¼šè§¦å‘cancelä¿¡å·ï¼Œåˆ™è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#75715e">// parent is never canceled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parentCancelCtx</span>(<span style="color:#a6e22e">parent</span>); <span style="color:#a6e22e">ok</span> { <span style="color:#75715e">//å½“å‰contextä¸ºåº“ä¸­ctxæ—¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// parent has already been canceled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">cancel</span>(<span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">children</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">children</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">canceler</span>]<span style="color:#66d9ef">struct</span>{})
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">children</span>[<span style="color:#a6e22e">child</span>] = <span style="color:#66d9ef">struct</span>{}{} <span style="color:#75715e">//åŠ å…¥pçš„children mapï¼Œç­‰å¾…pé‡Šæ”¾ä¿¡å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> { <span style="color:#75715e">//éåº“ä¸­cancelCtx,timeCtxæ—¶ï¼Œæ–°èµ·åç¨‹ç›‘å¬çˆ¶ctxçš„ä¿¡å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">Done</span>(): <span style="color:#75715e">// parentå…³é—­æ—¶ï¼Œå…³é—­child
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">cancel</span>(<span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">parent</span>.<span style="color:#a6e22e">Err</span>())
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">Done</span>():
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>cancelæ–¹æ³•çš„é€»è¾‘æ˜¯å…³é—­cancelCtxçš„Doneé€šé“ï¼Œå¹¶é€’å½’åœ°å…³é—­contextçš„æ‰€æœ‰å­contextã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">cancelCtx</span>) <span style="color:#a6e22e">cancel</span>(<span style="color:#a6e22e">removeFromParent</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> { <span style="color:#75715e">// å¤–å±‚ä¼ errors.New(&#34;context canceled&#34;) è¿™é‡Œä¸ä¼šè¿›å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        panic(<span style="color:#e6db74">&#34;context: internal error: missing cancel error&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>() <span style="color:#75715e">//ä¿æŠ¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> { <span style="color:#75715e">// å¯¹å·²ç»cancelçš„contextè¿›è¡Œcancel åˆ™è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#75715e">// already canceled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">err</span>  <span style="color:#75715e">//contextçš„errä¸º context cancel error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">done</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> { 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">done</span> = <span style="color:#a6e22e">closedchan</span>
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">done</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">child</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">children</span> { <span style="color:#75715e">//éå†å­contextå¯¹å…¶æ‰§è¡Œcancelæ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// NOTE: acquiring the child&#39;s lock while holding parent&#39;s lock.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">cancel</span>(<span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">err</span>) 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">children</span> = <span style="color:#66d9ef">nil</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">removeFromParent</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">removeChild</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="contextä½¿ç”¨è¯´æ˜">contextä½¿ç”¨è¯´æ˜ <a href="#context%e4%bd%bf%e7%94%a8%e8%af%b4%e6%98%8e" class="anchor">ğŸ”—</a></h3><p>etcdä¸­æœ‰ä¸€äº›select , context, channel çš„ä¾‹å­</p>
<p>å‚è€ƒï¼š <a href="https://blog.golang.org/context" target="_blank" rel="noopener">https://blog.golang.org/context</a></p>

    </div>

    
        <div class="tags">
            
                <a href="http://brettkk.github.io/tags/golang">golang</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    

    <script src="https://utteranc.es/client.js"
repo="brettKK/brettkk.github.io"
issue-term="title"
theme="github-light"
crossorigin="anonymous"
async>
</script>  

    <div class="copyright">
    
       Â© Copyright 
       2022 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-cactus-plus'>nodejh</a>
      </div>
    
</footer>




  </body>
</html>
