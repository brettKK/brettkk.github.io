<!DOCTYPE html>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<html lang="zh-cn">
  <head>
    <title>tidbå­¦ä¹  | brettkk</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="æ•´ä½“æ¶æ„ ğŸ”— äºŒå±‚ï¼ˆ1 sqlå±‚æ— çŠ¶æ€ï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚å’Œsqlè¿ç®—é€»">
<meta name="generator" content="Hugo 0.103.1" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/zenburn.min.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<link rel="stylesheet" href="http://brettkk.github.io/css/syntax.css" />


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />




  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>




  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">â†</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">tidbå­¦ä¹ </h1>

    <div class="tip">
        <time datetime="2023-01-05 11:33:56 &#43;0800 CST">Jan 5, 2023</time>
        <span class="split">
          Â·
        </span>
        <span>
          2341 words
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          5 minute read
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„</a>
      <ul>
        <li><a href="#å­˜å‚¨æ ¼å¼">å­˜å‚¨æ ¼å¼</a></li>
      </ul>
    </li>
    <li><a href="#çª¥æ¢ä¸€äºŒ">çª¥æ¢ä¸€äºŒ</a>
      <ul>
        <li><a href="#æ¨¡å—">æ¨¡å—</a></li>
      </ul>
    </li>
    <li><a href="#tidb-sqlæ‰§è¡Œè¿‡ç¨‹">tidb sqlæ‰§è¡Œè¿‡ç¨‹</a>
      <ul>
        <li><a href="#åˆ›å»ºè®¡åˆ’">åˆ›å»ºè®¡åˆ’</a></li>
        <li><a href="#é€»è¾‘ä¼˜åŒ–">é€»è¾‘ä¼˜åŒ–</a></li>
        <li><a href="#ç‰©ç†ä¼˜åŒ–">ç‰©ç†ä¼˜åŒ–</a></li>
        <li><a href="#tidb-plan--executor">tidb plan &amp; executor</a></li>
        <li><a href="#executor-ç‰©ç†è®¡åˆ’æ‰§è¡Œè¿‡ç¨‹">executor ç‰©ç†è®¡åˆ’æ‰§è¡Œè¿‡ç¨‹</a></li>
        <li><a href="#tikv-client">tikv-client</a></li>
      </ul>
    </li>
    <li><a href="#tikv">tikv</a>
      <ul>
        <li><a href="#å¹¶å‘æ§åˆ¶mvcc">å¹¶å‘æ§åˆ¶ï¼Œmvccã€‚</a></li>
        <li><a href="#rocksdb-è¯»å†™è·¯å¾„">rocksdb è¯»å†™è·¯å¾„</a></li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <h1 id="æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„ <a href="#%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84" class="anchor">ğŸ”—</a></h1><p>â€ƒâ€ƒäºŒå±‚ï¼ˆ1 sqlå±‚æ— çŠ¶æ€ï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚å’Œsqlè¿ç®—é€»è¾‘ï¼Œ2 kvå±‚å­˜å‚¨kvï¼‰ã€‚<br>
â€ƒâ€ƒä¸‰ä¸ªç»„ä»¶ï¼ˆtidb-server, tikv-server, pd-serverï¼‰<br></p>
<p><img src="/store_db/tidb_arch.png" width = "800" /><br></p>
<p><a href="https://github.com/pingcap/tidb" target="_blank" rel="noopener">tidb</a>: æ”¯æŒmysqlåè®®ï¼Œä»¥æ”¯æŒäº‹åŠ¡çš„åˆ†å¸ƒå¼kvå­˜å‚¨å¼•æ“ä¸ºåº•å±‚å­˜å‚¨çš„æ•°æ®åº“ã€‚</p>
<h2 id="å­˜å‚¨æ ¼å¼">å­˜å‚¨æ ¼å¼ <a href="#%e5%ad%98%e5%82%a8%e6%a0%bc%e5%bc%8f" class="anchor">ğŸ”—</a></h2><p>â€ƒâ€ƒå­˜å‚¨çš„æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šã€‚tableè¡¨å¦‚ä½•æ˜ å°„ä¸ºkvå­˜å‚¨ï¼Ÿ<br>
â€ƒâ€ƒä¸»é”®çš„kvç»“æ„ï¼škey=tableID_primaryID, value=[col1, col2...]<br>
â€ƒâ€ƒäºŒçº§ç´¢å¼•ï¼š key=tableID_ç´¢å¼•ID_primaryID, value=null<br></p>
<pre tabindex="0"><code>è¡Œæ•°æ®çš„kvæ ¼å¼
key: t{tableID}_r{rowID}
val:[col1, col2, col3]

unique indexçš„kvæ ¼å¼
key: t{tableID}_i{indexID}_columnsValue
value: rowID

non-unique index
key: t{tableID}_i{indexID}_columnsValue_rowID
value: null

rowå’Œindexçš„keyå…·æœ‰ç›¸åŒçš„prefixï¼Œä¸€ä¸ªtableå†…çš„æ•°æ®åœ¨tikvçš„keyç©ºé—´å†…æ˜¯æ’åˆ—åœ¨ä¸€èµ·çš„ã€‚
</code></pre><h1 id="çª¥æ¢ä¸€äºŒ">çª¥æ¢ä¸€äºŒ <a href="#%e7%aa%a5%e6%8e%a2%e4%b8%80%e4%ba%8c" class="anchor">ğŸ”—</a></h1><p>æœ‰ä¸€äº›æ¨¡å—æ˜¯make it workï¼Œ æœ‰ä¸€äº›æ¨¡å—æ˜¯make it fastã€‚</p>
<h2 id="æ¨¡å—">æ¨¡å— <a href="#%e6%a8%a1%e5%9d%97" class="anchor">ğŸ”—</a></h2><p>tidb-serverçš„å…¥å£tidb-server/main.go,
tidb-serverä¸­åˆ†ä¸‰å±‚ï¼š<br>
mysqlåè®®è§£æå’Œè½¬æ¢ä¸ºastï¼Œprotocol layer: serveråŒ…è´Ÿè´£ï¼Œ <br>
sql layer:  Sesssion(), RecordSet(), Plan(), Logical Plan, Physical Plan, Executor, distsql, store/tikv client <br>
kv api layer: Mock-Tikv <br></p>
<table>
<thead>
<tr>
<th>æ¨¡å—</th>
<th>åŠŸèƒ½</th>
<th>å…¶ä»–</th>
</tr>
</thead>
<tbody>
<tr>
<td>tidb-server</td>
<td>æœåŠ¡çš„å…¥å£main</td>
<td>âœ…</td>
</tr>
<tr>
<td>server</td>
<td>mysqlåè®®ï¼Œsessionç®¡ç†é€»è¾‘ ï¼Œ protocol layer</td>
<td>âœ…</td>
</tr>
<tr>
<td>plan</td>
<td>æŸ¥è¯¢ä¼˜åŒ–ç›¸å…³çš„é€»è¾‘</td>
<td>âœ…</td>
</tr>
<tr>
<td>expression</td>
<td>è¡¨è¾¾å¼ç›¸å…³çš„é€»è¾‘</td>
<td>âœ…</td>
</tr>
<tr>
<td>executor</td>
<td>sqlè¯­å¥çš„æ‰§è¡Œå™¨</td>
<td>âœ…</td>
</tr>
<tr>
<td>distsql</td>
<td>æŠŠexecutorå’Œtikv clientåšéš”ç¦»</td>
<td>âœ…</td>
</tr>
<tr>
<td>store/tikv</td>
<td>sqlå±‚ä¸å­˜å‚¨å¼•æ“çš„äº¤äº’</td>
<td>âŒ</td>
</tr>
<tr>
<td>ddl</td>
<td>ddlçš„æ‰§è¡Œé€»è¾‘</td>
<td>âŒ</td>
</tr>
<tr>
<td>tablecodec</td>
<td>sqlåˆ°kvçš„ç¼–è§£ç </td>
<td>âŒ</td>
</tr>
<tr>
<td>kv</td>
<td>è§„å®šäº†kvå¼•æ“çš„æ¥å£ï¼Œtikvå®ç°å®šä¹‰çš„æ¥å£ kv api layer</td>
<td>âœ…</td>
</tr>
</tbody>
</table>
<p>server/conn.go å¤§å¾ªç¯ä¸­ä¸æ–­è¯»å–æ•°æ®åŒ…<br>
server/conn.go#Dispatchå‡½æ•°å¤„ç†sqlæ–‡æœ¬<br>
å¤„ç†sqlæ–‡æœ¬çš„å‡½æ•°<code>handleQuery</code>æ”¶åˆ°sqlæ–‡æœ¬<br></p>
<p><a href="https://github.com/pingcap/tidb/blob/0b1096eac5a500f8c624f08f384d0194da5386f4/session/session.go#L167" target="_blank" rel="noopener">session/session.go#ExecuteStmt</a> æ‹¿åˆ°astã€‚<code>visitor</code> æ¨¡å¼è¿›è¡Œéå†.<br></p>
<p><a href="https://github.com/pingcap/tidb/blob/0b1096eac5a500f8c624f08f384d0194da5386f4/session/session.go#L2168" target="_blank" rel="noopener">compiler.Compileå¯¹sqlçš„aståšéªŒè¯ï¼Œä¼˜åŒ–åŠ¨ä½œçš„å…¥å£</a><br></p>
<p>ç”Ÿæˆæ‰§è¡Œå™¨executor/adaptor.go#Exec()..buildExcecutor(): plan -&gt; executorã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> a <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> c1 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><p>æ‰§è¡Œå™¨ projection(a) -&gt; filter(c1 &gt; 1) -&gt; table scan(t)ã€‚
è·å–æ•°æ®æ—¶rs.Next()æ–¹æ³•é“¾å¼è°ƒç”¨åˆ°åº•å±‚ï¼Œå½“å‰å±‚çš„å¤„ç†ä¾èµ–äºä¸‹å±‚è¿”å›çš„æ•°æ®ã€‚</p>
<p><a href="">server/conn.go#writeResultsetå†™å›client</a><br></p>
<p>client &lt;--&gt;sqlå¤„ç† &lt;--&gt; ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ &lt;---&gt; ç”Ÿæˆæ‰§è¡Œå™¨<br>
æ‰§è¡Œå™¨çš„æ‰§è¡Œæ˜¯ï¼šåœ¨éœ€è¦ç»™å®¢æˆ·ç«¯è¿”å›æ•°æ®çš„åœ°æ–¹è°ƒNext()æ–¹æ³•è·å–ç»“æœæ•°æ®ã€‚<br></p>
<h1 id="tidb-sqlæ‰§è¡Œè¿‡ç¨‹">tidb sqlæ‰§è¡Œè¿‡ç¨‹ <a href="#tidb-sql%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b" class="anchor">ğŸ”—</a></h1><p><img src="/store_db/tidb_sql_lifetime.png" width = "800" /><br></p>
<p>ä¸»è¦çš„åŒ…ï¼šparser, planner, executor<br></p>
<p>è™½ç„¶æ¶æ„ä¸Šåˆ†è®¡ç®—å±‚å’Œå­˜å‚¨å±‚ï¼Œä¸ºäº†é¿å…å¤§é‡çš„rpcï¼Œéœ€è¦å°†è®¡ç®—å°½é‡é è¿‘å­˜å‚¨èŠ‚ç‚¹ã€‚<br></p>
<h2 id="åˆ›å»ºè®¡åˆ’">åˆ›å»ºè®¡åˆ’ <a href="#%e5%88%9b%e5%bb%ba%e8%ae%a1%e5%88%92" class="anchor">ğŸ”—</a></h2><p><code>planbuilder.go#Build</code> æ ¹æ®<code>ast.Node</code>èŠ‚ç‚¹çš„ç±»å‹æ¥åˆ›å»ºè®¡åˆ’ï¼Œ ä¾‹å¦‚<code>Insert</code>, <code>LogicalJoin</code>, <code>DataSource</code></p>
<h2 id="é€»è¾‘ä¼˜åŒ–">é€»è¾‘ä¼˜åŒ– <a href="#%e9%80%bb%e8%be%91%e4%bc%98%e5%8c%96" class="anchor">ğŸ”—</a></h2><p>åˆ©ç”¨å…³ç³»ä»£æ•°çš„å˜æ¢è§„åˆ™è¿›è¡ŒæŸ¥è¯¢è¯­å¥è¡¨è¾¾å¼çš„ç­‰ä»·å˜æ¢<br>
é€»è¾‘ä¼˜åŒ–æ˜¯åŸºäºé¢„å…ˆå®šä¹‰çš„è§„åˆ™åˆ—è¡¨<code>logicalOptRule</code> passå®šä¹‰å¤„ç†<br></p>
<p>é€»è¾‘ç®—å­ï¼š</p>
<ul>
<li>DataSource è´Ÿè´£æ•°æ®æº(å¯èƒ½åŒ…å«ä¸‹æ¨çš„æ¡ä»¶è°“è¯)</li>
<li>Selection é€‰æ‹©ã€‚ where id = 5 ä¸­çš„whereè¿‡æ»¤æ¡ä»¶</li>
<li>Projection æŠ•å½±ã€‚ select cï¼Œ a+b ä¸­å–cåˆ—çš„æ“ä½œæ˜¯æŠ•å½±, ä¹Ÿæœ‰è¡¨è¾¾å¼è®¡ç®—</li>
<li>Join è¿æ¥ã€‚ from t1, t2 where t1.c = t2.d æŠŠt1 å’Œ t2å†…è¿æ¥ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–joinæ–¹å¼</li>
<li>Sortã€‚ select * from t order by c ä¸­çš„order by</li>
<li>Aggregation èšåˆæ“ä½œã€‚ (select sum(d) from t group by e)ä¸­çš„group byï¼Œ sumã€‚</li>
<li>Applyã€‚  å­æŸ¥è¯¢</li>
</ul>
<p>columnPruner åˆ—è£å‰ªï¼ˆä»ä¸Šå¾€ä¸‹ä¸€è·¯åŠ columnï¼‰ plan/column_pruning.go <br></p>
<p><code>æœ€å¤§æœ€å°æ¶ˆé™¤</code>å°†max/minè½¬ä¸º<code>order by id + limit 1</code>ã€‚ æŠ•å½±æ¶ˆé™¤<br></p>
<p><code>PredicatePushDown</code>è°“è¯ä¸‹æ¨: æŠŠè¿‡æ»¤æ¡ä»¶æ¨åˆ°<code>DataSource</code>ç®—å­ä¸Šï¼Œåœ¨leaf nodeä¸­æ‰§è¡Œå‡å°‘æ•°æ®è®¿é—®ã€‚<br></p>
<p><code>cop[tikv]</code> <code>root[tidb]</code>
æ‰€æœ‰çš„ Join æ“ä½œéƒ½åªèƒ½ä½œä¸º root task åœ¨ TiDB ä¸Šæ‰§è¡Œã€‚<br></p>
<h2 id="ç‰©ç†ä¼˜åŒ–">ç‰©ç†ä¼˜åŒ– <a href="#%e7%89%a9%e7%90%86%e4%bc%98%e5%8c%96" class="anchor">ğŸ”—</a></h2><p>ç‰©ç†ä¼˜åŒ–æ˜¯åŸºäºä»£ä»·çš„æ–¹å¼ã€‚ <br></p>
<p><code>dagPhysicalOptimize</code></p>
<h2 id="tidb-plan--executor">tidb plan &amp; executor <a href="#tidb-plan--executor" class="anchor">ğŸ”—</a></h2><p><code>select name from person where age = 18</code> <br></p>
<p>logical plan: <br></p>
<ul>
<li>scan table person</li>
<li>selection age = 18</li>
<li>projection name</li>
</ul>
<p><strong>é€»è¾‘è®¡åˆ’ å¯¹åº”å¤šç§ç‰©ç†è®¡åˆ’</strong><br>
é€»è¾‘è®¡åˆ’ -&gt; ç‰©ç†è®¡åˆ’ï¼ˆå…·ä½“çš„æ“ä½œç®—å­ï¼‰<br>
ä¾‹å¦‚ï¼š é€»è¾‘ç®—å­datasource (ç‰©ç†ç®—å­IndexReader, TableReader, IndexLookUpReader)<br></p>
<p>Join (HashJoin, SortMergeJoin, Index Lookup Join)<br></p>
<ul>
<li>HashJoin: ä¼°è®¡å‡ºå°è¡¨ï¼Œå°è¡¨ç”Ÿæˆhashè¡¨ï¼Œå¤§è¡¨æ‰§è¡Œconstains key åŒ¹é…å‡ºç»“æœ</li>
<li>Index Lookup Joinï¼š outerè¡¨çš„æ•°æ®ä¸innerè¡¨çš„index keyèŒƒå›´</li>
<li>Sort Merge Joinï¼š é€šå¸¸åœ¨è¿æ¥çš„åˆ—ä¸Šæœ‰ç´¢å¼•æ—¶å¯ä»¥è€ƒè™‘ã€‚æŒ‰è¿æ¥çš„åˆ—å€¼è¿›è¡Œæ’åºï¼Œè¿›è¡Œå½’å¹¶å¾—åˆ°ç»“æœ</li>
</ul>
<p>æ‰§è¡Œè®¡åˆ’çš„é€»è¾‘ä¼˜åŒ–ï¼ˆåŸºäºè§„åˆ™çš„ä¼˜åŒ–RBOï¼‰ï¼Œä¾‹å¦‚åˆ—è£å‰ªï¼ŒæŠ•å½±æ¶ˆé™¤ï¼Œ è°“è¯ä¸‹æ¨ï¼ˆå…ˆç­›é€‰ï¼Œå†åšæ•°æ®è¿æ¥ï¼‰<br>
æ‰§è¡Œè®¡åˆ’çš„ç‰©ç†ä¼˜åŒ– (åŸºäºä»£ä»·çš„ä¼˜åŒ–CBO)ï¼Œ ç­‰ä»·è½¬æ¢ï¼Œ</p>
<h2 id="executor-ç‰©ç†è®¡åˆ’æ‰§è¡Œè¿‡ç¨‹">executor ç‰©ç†è®¡åˆ’æ‰§è¡Œè¿‡ç¨‹ <a href="#executor-%e7%89%a9%e7%90%86%e8%ae%a1%e5%88%92%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b" class="anchor">ğŸ”—</a></h2><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">//session/session.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">session</span>) <span style="color:#a6e22e">ExecuteStmt</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">stmtNode</span> <span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">StmtNode</span>) (<span style="color:#a6e22e">sqlexec</span>.<span style="color:#a6e22e">RecordSet</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">compiler</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">executor</span>.<span style="color:#a6e22e">Compiler</span>{<span style="color:#a6e22e">Ctx</span>: <span style="color:#a6e22e">s</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ç”ŸæˆæŸ¥è¯¢è®¡åˆ’ä»¥åŠä¼˜åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">stmt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">compiler</span>.<span style="color:#a6e22e">Compile</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stmtNode</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">logStmt</span>(<span style="color:#a6e22e">stmt</span>, <span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å»tikvä¸Šè·å–æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">recordSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runStmt</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">stmt</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">recordSet</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>volcano</code>ç«å±±æ¨¡å‹ã€‚ è¿­ä»£å™¨æ¨¡å‹ã€‚<br>
æ¯ä¸ªç‰©ç†ç®—å­å‡å®ç°Open, Next, Closeæ–¹æ³•<br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#a6e22e">Projection</span>) <span style="color:#a6e22e">Next</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">row</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">children</span>.<span style="color:#a6e22e">Next</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">row</span>.<span style="color:#a6e22e">name</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">Selection</span>) <span style="color:#a6e22e">Next</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">row</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">children</span>.<span style="color:#a6e22e">Next</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">row</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">row</span>.<span style="color:#a6e22e">age</span> = <span style="color:#ae81ff">18</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">row</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">Scan</span>) <span style="color:#a6e22e">Next</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">person</span>.<span style="color:#a6e22e">read</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="tikv-client">tikv-client <a href="#tikv-client" class="anchor">ğŸ”—</a></h2><p>todo
<a href="https://github.com/pingcap/tidb/tree/master/store/mockstore" target="_blank" rel="noopener">tidb-serveré‡Œæ¨¡æ‹Ÿtikvä¸­çš„è®¡ç®—é€»è¾‘mock-tikv</a><br></p>
<hr>
<h1 id="tikv">tikv <a href="#tikv" class="anchor">ğŸ”—</a></h1><p><code>åˆ†å¸ƒå¼</code> <code>äº‹åŠ¡</code> <code>k-v pair</code> <br></p>
<p>å•æœºå­˜å‚¨é rocksdbæ¥å­˜å‚¨åˆ°ç£ç›˜ä¸Šã€‚åˆ†å¸ƒå¼æ•°æ®å¤åˆ¶é raftã€‚</p>
<p><code>row -&gt; region -&gt; store -&gt; database</code></p>
<table>
<thead>
<tr>
<th>åˆ†å±‚</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody>
<tr>
<td>kvservice / coprocessor api</td>
<td>kv è¯·æ±‚ï¼Œ sqlè®¡ç®—</td>
</tr>
<tr>
<td>txn</td>
<td>mvcc, 2pc</td>
</tr>
<tr>
<td>shading + replicaï¼ˆmulti raftï¼‰</td>
<td>æ—¥å¿—å¤åˆ¶ï¼Œåˆ†å¸ƒå¼ä¸€è‡´æ€§</td>
</tr>
<tr>
<td>storage engine</td>
<td>rocksdb å•æœºå­˜å‚¨</td>
</tr>
<tr>
<td>os file system</td>
<td>è´Ÿè´£ç£ç›˜å­˜å‚¨</td>
</tr>
</tbody>
</table>
<h2 id="å¹¶å‘æ§åˆ¶mvcc">å¹¶å‘æ§åˆ¶ï¼Œmvccã€‚ <a href="#%e5%b9%b6%e5%8f%91%e6%8e%a7%e5%88%b6mvcc" class="anchor">ğŸ”—</a></h2><p>Timestamp Oracle(TSO) é€’å¢æ—¶é—´æˆ³ä½œä¸ºç‰ˆæœ¬å·ã€‚<br>
prewriteæ—¶çš„å†²çªæ£€æŸ¥ï¼š 1ã€æ£€æŸ¥column family <code>lock</code>ä¸Škeyæ˜¯å¦è¢«lockäº†ï¼Œ 2ã€åœ¨cf writeä¸Škeyçš„ç‰ˆæœ¬å·æ˜¯å¦å°äºå½“å‰äº‹ç‰©æŒæœ‰çš„TSOï¼Œ å¦åˆ™rollback <br>
prewriteæ—¶é€‰æ‹©å¤šä¸ªkeyä¸­çš„ä¸€ä¸ªä½œä¸ºprimary keyï¼Œ Lockåˆ—åŠ é”ï¼›å…¶ä»–çš„ä½œä¸ºsecondry keyï¼ŒLockåˆ—åŠ é”ï¼Œå¤–åŠ å­˜å‚¨primary key(å¼‚æ­¥æäº¤å¤±è´¥åï¼Œä¸‹æ¬¡æŸ¥è¯¢ä¼šæŸ¥è¯¢primary keyè‹¥æäº¤åä¼šè¡¥å……æäº¤)ã€‚<br></p>
<h2 id="rocksdb-è¯»å†™è·¯å¾„">rocksdb è¯»å†™è·¯å¾„ <a href="#rocksdb-%e8%af%bb%e5%86%99%e8%b7%af%e5%be%84" class="anchor">ğŸ”—</a></h2><p>write: memtable(skiplistt) --&gt; immutable table --&gt; String store table (SST) <br>
read:  the same path<br></p>
<p>å¯¹ DB æ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹ <a href="https://github.com/joaoh82/rust_sqlite" target="_blank" rel="noopener">https://github.com/joaoh82/rust_sqlite</a></p>

    </div>

    
        <div class="tags">
            
                <a href="http://brettkk.github.io/tags/%E5%AD%98%E5%82%A8">å­˜å‚¨</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    

    <script src="https://utteranc.es/client.js"
repo="brettKK/brettkk.github.io"
issue-term="title"
theme="github-light"
crossorigin="anonymous"
async>
</script>  

    <div class="copyright">
    
       Â© Copyright 
       2023 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-cactus-plus'>nodejh</a>
      </div>
    
</footer>




  </body>
</html>
