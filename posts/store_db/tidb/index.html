<!DOCTYPE html>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<html lang="zh-cn">
  <head>
    <title>tidbå­¦ä¹  | brettkk</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="æ•´ä½“æ¶æ„ ğŸ”—äºŒå±‚ï¼ˆsqlå±‚æ— çŠ¶æ€ï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚å’Œsqlè¿ç®—é€»è¾‘">
<meta name="generator" content="Hugo 0.103.1" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link href="https://cdn.bootcss.com/highlight.js/9.15.10/styles/zenburn.min.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<link rel="stylesheet" href="http://brettkk.github.io/css/syntax.css" />


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />




  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>




  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">â†</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">tidbå­¦ä¹ </h1>

    <div class="tip">
        <time datetime="2021-05-05 11:33:56 &#43;0800 CST">May 5, 2021</time>
        <span class="split">
          Â·
        </span>
        <span>
          1709 words
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          4 minute read
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li><a href="#æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„</a></li>
    <li><a href="#çª¥æ¢ä¸€äºŒ">çª¥æ¢ä¸€äºŒ</a>
      <ul>
        <li><a href="#ä¸ºä»€ä¹ˆåªæ˜¯çª¥æ¢ä¸€äºŒ">ä¸ºä»€ä¹ˆåªæ˜¯çª¥æ¢ä¸€äºŒ</a></li>
        <li><a href="#æ¨¡å—">æ¨¡å—</a></li>
        <li><a href="#selectè¯­å¥çš„å¤„ç†è¿‡ç¨‹">selectè¯­å¥çš„å¤„ç†è¿‡ç¨‹</a></li>
        <li><a href="#tikv-client">tikv-client</a></li>
        <li><a href="#æ•°æ®åº“ç›¸å…³è®¡ç®—é€»è¾‘tidb-server">æ•°æ®åº“ç›¸å…³è®¡ç®—é€»è¾‘ã€tidb-server</a>
          <ul>
            <li><a href="#heading"></a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#tikv">tikv</a></li>
    <li><a href="#rocksdb">rocksdb</a></li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <h1 id="æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„ <a href="#%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84" class="anchor">ğŸ”—</a></h1><p>äºŒå±‚ï¼ˆsqlå±‚æ— çŠ¶æ€ï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚å’Œsqlè¿ç®—é€»è¾‘ï¼Œ kvå±‚å­˜å‚¨kvï¼‰ã€‚ä¸‰ä¸ªç»„ä»¶ï¼ˆtidb-server, tikv-server, pd-serverï¼‰<br></p>
<p><a href="https://github.com/pingcap/tidb" target="_blank" rel="noopener">tidb</a>: æ”¯æŒmysqlåè®®ï¼Œä»¥æ”¯æŒäº‹åŠ¡çš„åˆ†å¸ƒå¼kvå­˜å‚¨å¼•æ“ä¸ºåº•å±‚å­˜å‚¨çš„æ•°æ®åº“ã€‚</p>
<h1 id="çª¥æ¢ä¸€äºŒ">çª¥æ¢ä¸€äºŒ <a href="#%e7%aa%a5%e6%8e%a2%e4%b8%80%e4%ba%8c" class="anchor">ğŸ”—</a></h1><h2 id="ä¸ºä»€ä¹ˆåªæ˜¯çª¥æ¢ä¸€äºŒ">ä¸ºä»€ä¹ˆåªæ˜¯çª¥æ¢ä¸€äºŒ <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%8f%aa%e6%98%af%e7%aa%a5%e6%8e%a2%e4%b8%80%e4%ba%8c" class="anchor">ğŸ”—</a></h2><p>ä¸ºä»€ä¹ˆåªæ˜¯çª¥æ¢ä¸€äºŒï¼Œä¸ºä»€ä¹ˆè¦å¿½ç•¥ã€‚<br>
è½¯ä»¶å¹¶éä¸€æœä¸€å¤•æ„å»ºå‡ºæ¥çš„ï¼Œæ˜¯ä¸€ç¾¤äººåœ¨å¾ˆé•¿æ—¶é—´ä¸Šç´¯åŠ å‡ºæ¥çš„äº§ç‰©ã€‚ä¾‹å¦‚<code>linux</code>ï¼Œ<code>gcc</code>,<code>llvm</code>ç­‰å¤§å‹è½¯ä»¶ï¼Œä¸€ä¸ªäººæ˜¯ä¸å¯èƒ½å®Œå…¨çœ‹å®Œçš„ã€‚<br>
ä¸€ä¸ªäººæ—¶é—´ã€ç²¾åŠ›ã€èƒ½åŠ›æœ‰é™ï¼Œä¼šé€‰æ‹©å¿½ç•¥æ‰ä¸€äº›å†…å®¹ï¼Œèƒ½å¤Ÿæ„å»ºå‡ºè‡ªå·±çš„è„‰ç»œå’Œå®Œå…¨ç†è§£å…¶ä¸­ä¸€ä¸¤ä¸ªç‚¹å°±å¯ä»¥äº†ã€‚<br>
æ•´ä½“ä¸å±€éƒ¨ï¼š å…ˆæœ‰æ•´ä½“ï¼ŒçŸ¥é“æ•´ä½“å¤§è‡´æ˜¯æ€ä¹ˆworkçš„ï¼Œç„¶åå¯¹äºæœ‰æ„æ€çš„éƒ¨åˆ†è¿›è¡Œç†è§£ï¼Œä¸ç„¶å®¹æ˜“è¿·å¤±åœ¨èŒ«èŒ«ä»£ç ä¸­ã€‚ <br></p>
<p>æœ‰ä¸€äº›æ¨¡å—æ˜¯make it workï¼Œ æœ‰ä¸€äº›æ¨¡å—æ˜¯make it fastã€‚</p>
<h2 id="æ¨¡å—">æ¨¡å— <a href="#%e6%a8%a1%e5%9d%97" class="anchor">ğŸ”—</a></h2><p>tidb-serverä¸­åˆ†ä¸‰å±‚ï¼š<br>
mysqlåè®®è§£æå’Œè½¬æ¢ä¸ºastï¼Œprotocol layer: serveråŒ…è´Ÿè´£ï¼Œ <br>
sql layer:  Sesssion(), RecordSet(), Plan(), Logical Plan, Physical Plan, Executor, distsql, store/tikv client <br>
kv api layer: Mock-Tikv <br></p>
<table>
<thead>
<tr>
<th>æ¨¡å—</th>
<th>åŠŸèƒ½</th>
<th>å…¶ä»–</th>
</tr>
</thead>
<tbody>
<tr>
<td>tidb-server</td>
<td>æœåŠ¡çš„å…¥å£main</td>
<td>âœ…</td>
</tr>
<tr>
<td>server</td>
<td>mysqlåè®®ï¼Œsessionç®¡ç†é€»è¾‘ ï¼Œ protocol layer</td>
<td>âœ…</td>
</tr>
<tr>
<td>plan</td>
<td>æŸ¥è¯¢ä¼˜åŒ–ç›¸å…³çš„é€»è¾‘</td>
<td>âŒ</td>
</tr>
<tr>
<td>expression</td>
<td>è¡¨è¾¾å¼ç›¸å…³çš„é€»è¾‘</td>
<td>âŒ</td>
</tr>
<tr>
<td>executor</td>
<td>sqlè¯­å¥çš„æ‰§è¡Œå™¨</td>
<td>âŒ</td>
</tr>
<tr>
<td>distsql</td>
<td>æŠŠexecutorå’Œtikv clientåšéš”ç¦»</td>
<td>âœ…</td>
</tr>
<tr>
<td>store/tikv</td>
<td>sqlå±‚ä¸å­˜å‚¨å¼•æ“çš„äº¤äº’</td>
<td>âœ…</td>
</tr>
<tr>
<td>ddl</td>
<td>ddlçš„æ‰§è¡Œé€»è¾‘</td>
<td>âŒ</td>
</tr>
<tr>
<td>tablecodec</td>
<td>sqlåˆ°kvçš„ç¼–è§£ç </td>
<td>âœ…</td>
</tr>
<tr>
<td>types</td>
<td></td>
<td></td>
</tr>
<tr>
<td>kv</td>
<td>è§„å®šäº†kvå¼•æ“çš„æ¥å£ï¼Œtikvå®ç°å®šä¹‰çš„æ¥å£ kv api layer</td>
<td>âœ…</td>
</tr>
<tr>
<td>tidb</td>
<td></td>
<td>âœ…</td>
</tr>
</tbody>
</table>
<p><a href="">server/conn.go å¤§å¾ªç¯ä¸­ä¸æ–­è¯»å–æ•°æ®åŒ…</a><br>
<a href="">server/conn.go#Dispatchå‡½æ•°å¤„ç†sqlæ–‡æœ¬</a><br>
å¤„ç†sqlæ–‡æœ¬çš„å‡½æ•°<code>handleQuery</code>æ”¶åˆ°sqlæ–‡æœ¬ï¼Œè¿”å›clientæœ€åçš„ç»“æœ<br></p>
<p><a href="https://github.com/pingcap/tidb/blob/0b1096eac5a500f8c624f08f384d0194da5386f4/session/session.go#L167" target="_blank" rel="noopener">session/session.go#ExecuteStmt</a> æ‹¿åˆ°astã€‚<code>visitor</code> æ¨¡å¼è¿›è¡Œéå†.<br></p>
<p><a href="https://github.com/pingcap/tidb/blob/0b1096eac5a500f8c624f08f384d0194da5386f4/session/session.go#L2168" target="_blank" rel="noopener">compiler.Compileå¯¹sqlçš„aståšéªŒè¯ï¼Œä¼˜åŒ–åŠ¨ä½œçš„å…¥å£</a><br>
plan.Preprocessåˆæ³•æ€§æ£€æŸ¥ç­‰ã€‚ plan.Optimizeç”ŸæˆæŸ¥è¯¢è®¡åˆ’ã€‚ executor.ExecStmtç»“æ„ä½“ï¼ˆæœ‰final planï¼‰ä¿¡æ¯ï¼Œåç»­æ‰§è¡Œçš„åŸºç¡€ã€‚<br></p>
<p>ç”Ÿæˆæ‰§è¡Œå™¨executor/adaptor.go#Exec()..buildExcecutor(): plan -&gt; executorã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> a <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> c1 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><p>æ‰§è¡Œå™¨ projection(a) -&gt; filter(c1 &gt; 1) -&gt; table scan(t)ã€‚
è·å–æ•°æ®æ—¶rs.Next()æ–¹æ³•é“¾å¼è°ƒç”¨åˆ°åº•å±‚ï¼Œå½“å‰å±‚çš„å¤„ç†ä¾èµ–äºä¸‹å±‚è¿”å›çš„æ•°æ®ã€‚</p>
<p><a href="">server/conn.go#writeResultsetå†™å›client</a><br></p>
<p>client &lt;--&gt;sqlå¤„ç† &lt;--&gt; ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ &lt;---&gt; ç”Ÿæˆæ‰§è¡Œå™¨<br>
æ‰§è¡Œå™¨çš„æ‰§è¡Œæ˜¯ï¼šåœ¨éœ€è¦ç»™å®¢æˆ·ç«¯è¿”å›æ•°æ®çš„åœ°æ–¹è°ƒNext()æ–¹æ³•è·å–ç»“æœæ•°æ®ã€‚<br>
è¿˜æœ‰å¾ˆå¤šæ¨¡å—å’Œç»†èŠ‚ï¼Œ<code>ast</code>, todo...<br></p>
<h2 id="selectè¯­å¥çš„å¤„ç†è¿‡ç¨‹">selectè¯­å¥çš„å¤„ç†è¿‡ç¨‹ <a href="#select%e8%af%ad%e5%8f%a5%e7%9a%84%e5%a4%84%e7%90%86%e8%bf%87%e7%a8%8b" class="anchor">ğŸ”—</a></h2><p>ast - buildSelect()-&gt; Logical plan - doOptimize(logicalOptimize, dagPhysicalOptimize) -&gt; final plan<br></p>
<p>sqlå±‚å‘è¿‡æ¥key rangeï¼Œ è¯·æ±‚pdæ‹¿åˆ°regionä¿¡æ¯ï¼Œå°†key rangeæŒ‰regionåˆ’åˆ†ï¼Œå°†è¯·æ±‚å‘é€åˆ°tikvä¸Šçš„regionã€‚</p>
<p>å•ä¸ªtidb-serverå‘é€ä»»åŠ¡åˆ°å¤šä¸ªtikv-serverï¼Œåœ¨è¿›è¡Œæ±‡æ€»<br></p>
<p>sqlä¼˜åŒ–è¿‡ç¨‹ï¼š é€»è¾‘ä¼˜åŒ–ï¼ˆæ ¹æ®ruleï¼Œåˆ—è£å‰ªï¼‰ï¼Œ ç‰©ç†ä¼˜åŒ–ï¼ˆåŸºäºä»£ä»·ï¼‰ã€‚</p>
<p>åˆ—è£å‰ª plan/column_pruning.go <br>
æœ€å¤§æœ€å°æ¶ˆé™¤, æŠ•å½±æ¶ˆé™¤<br>
è°“è¯ä¸‹æ¨: æŠŠè¿‡æ»¤æ¡ä»¶æ¨åˆ°leaf nodeï¼Œå‡å°‘æ•°æ®è®¿é—®ã€‚</p>
<h2 id="tikv-client">tikv-client <a href="#tikv-client" class="anchor">ğŸ”—</a></h2><p>TiDBçš„æ•°æ®åˆ†å¸ƒæ˜¯ä»¥Regionä¸ºå•ä½çš„ï¼Œä¸€ä¸ªregionåŒ…å«ä¸€ä¸ªèŒƒå›´çš„æ•°æ®ã€‚<br></p>
<p>kv.Storageæ¥å£æ–¹ä¾¿å¤–éƒ¨è°ƒç”¨ã€‚ tikv- clientå®ç°kv.Storageæ¥å£ï¼Œå°è£…rpcç»†èŠ‚ã€‚</p>
<p>tikv-client ç¼“å­˜regionä¿¡æ¯ï¼ŒRegionCache(map, B-tree)ã€‚</p>
<h2 id="æ•°æ®åº“ç›¸å…³è®¡ç®—é€»è¾‘tidb-server">æ•°æ®åº“ç›¸å…³è®¡ç®—é€»è¾‘ã€tidb-server <a href="#%e6%95%b0%e6%8d%ae%e5%ba%93%e7%9b%b8%e5%85%b3%e8%ae%a1%e7%ae%97%e9%80%bb%e8%be%91tidb-server" class="anchor">ğŸ”—</a></h2><p>ä¸€èˆ¬tidbæŒ‡çš„æ˜¯tidb-serverã€‚
<a href="https://github.com/pingcap/tidb/tree/master/store/mockstore" target="_blank" rel="noopener">tidb-serveré‡Œæ¨¡æ‹Ÿtikvä¸­çš„è®¡ç®—é€»è¾‘mock-tikv</a><br></p>
<p>tidb(tidb-server)ï¼Œæœ‰å“ªäº›æ¨¡å—ï¼Œå“ªäº›å¥½å…¥æ‰‹çš„æ¨¡å—ã€‚<br>
tidb-serverçš„å…¥å£tidb-server/main.go,</p>
<h3 id="heading"> <a href="#heading" class="anchor">ğŸ”—</a></h3><p>å¯ä»¥æ·±å…¥çš„æ¨¡å—ï¼Œ ä¼˜åŒ–å™¨çš„å®ç°ï¼Œ é€»è¾‘ä¼˜åŒ–ï¼Œç‰©ç†ä¼˜åŒ–ã€‚</p>
<pre tabindex="0"><code>è¡Œæ•°æ®çš„kvæ ¼å¼
key: t{tableID}_r{rowID}
val:[col1, col2, col3]

unique indexçš„kvæ ¼å¼
key: t{tableID}_i{indexID}_columnsValue
value: rowID

non-unique index
key: t{tableID}_i{indexID}_columnsValue_rowID
value: null

rowå’Œindexçš„keyå…·æœ‰ç›¸åŒçš„prefixï¼Œä¸€ä¸ªtableå†…çš„æ•°æ®åœ¨tikvçš„keyç©ºé—´å†…æ˜¯æ’åˆ—åœ¨ä¸€èµ·çš„ã€‚
</code></pre><h1 id="tikv">tikv <a href="#tikv" class="anchor">ğŸ”—</a></h1><p>å•æœºå­˜å‚¨é rocksdbæ¥å­˜å‚¨åˆ°ç£ç›˜ä¸Šã€‚åˆ†å¸ƒå¼æ•°æ®å¤åˆ¶é raftã€‚
å¿½ç•¥raftã€‚</p>
<p>rustä»£ç ï¼ŒåŠ å…¥assertï¼ã€‚</p>
<h1 id="rocksdb">rocksdb <a href="#rocksdb" class="anchor">ğŸ”—</a></h1>
    </div>

    
        <div class="tags">
            
                <a href="http://brettkk.github.io/tags/%E5%AD%98%E5%82%A8">å­˜å‚¨</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    

    <script src="https://utteranc.es/client.js"
repo="brettKK/brettkk.github.io"
issue-term="title"
theme="github-light"
crossorigin="anonymous"
async>
</script>  

    <div class="copyright">
    
       Â© Copyright 
       2022 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-cactus-plus'>nodejh</a>
      </div>
    
</footer>




  </body>
</html>
